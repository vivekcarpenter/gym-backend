{
    "sourceFile": "src/routes/member.routes.ts",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 44,
            "patches": [
                {
                    "date": 1752209752670,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1752212225456,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,9 +1,68 @@\n import express from 'express';\r\n-import { createMember } from '../controllers/member.controller';\r\n-import { validateMember } from '../middlewares/validateMember';\r\n+import { PrismaClient } from '@prisma/client';\r\n \r\n const router = express.Router();\r\n+const prisma = new PrismaClient();\r\n \r\n-router.post('/members', validateMember, createMember);\r\n+router.post('/members', async (req, res) => {\r\n+  try {\r\n+    const {\r\n+      firstName, lastName, email, phone, work, dateOfBirth, gender, avatar,\r\n+      club, keyFob, tags, note, memberType,\r\n+      address, marketing, additional, emergency,\r\n+      medicalInfo,\r\n+    } = req.body;\r\n \r\n+    const newMember = await prisma.member.create({\r\n+      data: {\r\n+        firstName,\r\n+        lastName,\r\n+        email,\r\n+        phone,\r\n+        work,\r\n+        dateOfBirth: dateOfBirth ? new Date(dateOfBirth) : null,\r\n+        gender,\r\n+        avatarUrl: avatar || null,\r\n+        keyFob,\r\n+        tags,\r\n+        note,\r\n+        memberType,\r\n+\r\n+        // Address\r\n+        street: address?.street || null,\r\n+        city: address?.city || null,\r\n+        state: address?.state || null,\r\n+        zip: address?.zip || null,\r\n+        addressSearch: address?.search || null,\r\n+\r\n+        // Marketing\r\n+        salesRep: marketing?.salesRep || null,\r\n+        sourcePromotion: marketing?.sourcePromotion || null,\r\n+        referredBy: marketing?.referredBy || null,\r\n+\r\n+        // Additional\r\n+        trainerId: additional?.trainerId || null,\r\n+        joiningDate: additional?.joiningDate ? new Date(additional.joiningDate) : null,\r\n+        occupation: additional?.occupation || null,\r\n+        organization: additional?.organization || null,\r\n+        involvementType: additional?.involvementType || null,\r\n+\r\n+        // Emergency\r\n+        emergencyName: emergency?.name || null,\r\n+        emergencyRelationship: emergency?.relationship || null,\r\n+        emergencyPhone: emergency?.phone || null,\r\n+        emergencyEmail: emergency?.email || null,\r\n+\r\n+        medicalInfo,\r\n+        clubId: club,\r\n+      },\r\n+    });\r\n+\r\n+    res.status(201).json(newMember);\r\n+  } catch (err) {\r\n+    console.error('Add Member Error:', err);\r\n+    res.status(500).json({ error: 'Failed to create member' });\r\n+  }\r\n+});\r\n+\r\n export default router;\r\n"
                },
                {
                    "date": 1752213377360,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -3,9 +3,9 @@\n \r\n const router = express.Router();\r\n const prisma = new PrismaClient();\r\n \r\n-router.post('/members', async (req, res) => {\r\n+router.post('/', async (req, res) => {\r\n   try {\r\n     const {\r\n       firstName, lastName, email, phone, work, dateOfBirth, gender, avatar,\r\n       club, keyFob, tags, note, memberType,\r\n"
                },
                {
                    "date": 1752214917703,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -64,5 +64,67 @@\n     res.status(500).json({ error: 'Failed to create member' });\r\n   }\r\n });\r\n \r\n+router.get('/', async (req, res) => {\r\n+  try {\r\n+    const { tab = 'all', search = '', page = 1, limit = 10, clubId } = req.query;\r\n+    const skip = (Number(page) - 1) * Number(limit);\r\n+\r\n+    let whereClause: any = {\r\n+      clubId: String(clubId),\r\n+    };\r\n+\r\n+    if (search) {\r\n+      whereClause.OR = [\r\n+        { firstName: { contains: search, mode: 'insensitive' } },\r\n+        { lastName: { contains: search, mode: 'insensitive' } },\r\n+        { email: { contains: search, mode: 'insensitive' } },\r\n+      ];\r\n+    }\r\n+\r\n+    switch (tab) {\r\n+      case 'active':\r\n+        whereClause.memberType = 'member';\r\n+        break;\r\n+      case 'expired':\r\n+        whereClause.memberType = 'member';\r\n+        whereClause.keyFob = null;\r\n+        break;\r\n+      case 'prospect':\r\n+        whereClause.memberType = 'prospect';\r\n+        break;\r\n+      case 'recent':\r\n+        const thirtyDaysAgo = new Date();\r\n+        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);\r\n+        whereClause.createdAt = { gte: thirtyDaysAgo };\r\n+        break;\r\n+      default:\r\n+        break;\r\n+    }\r\n+\r\n+    const [members, total] = await Promise.all([\r\n+      prisma.member.findMany({\r\n+        where: whereClause,\r\n+        orderBy: { createdAt: 'desc' },\r\n+        skip,\r\n+        take: Number(limit),\r\n+      }),\r\n+      prisma.member.count({ where: whereClause }),\r\n+    ]);\r\n+\r\n+    res.json({\r\n+      data: members,\r\n+      meta: {\r\n+        total,\r\n+        page: Number(page),\r\n+        pageSize: Number(limit),\r\n+      },\r\n+    });\r\n+  } catch (err) {\r\n+    console.error(err);\r\n+    res.status(500).json({ error: 'Failed to fetch members' });\r\n+  }\r\n+});\r\n+\r\n+\r\n export default router;\r\n"
                },
                {
                    "date": 1752218281891,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -125,6 +125,29 @@\n     res.status(500).json({ error: 'Failed to fetch members' });\r\n   }\r\n });\r\n \r\n+// GET /api/members/:id\r\n+router.get('/:id', async (req, res) => {\r\n+  const { id } = req.params;\r\n \r\n+  try {\r\n+    const member = await prisma.member.findUnique({\r\n+      where: { id },\r\n+      include: {\r\n+        trainer: true,\r\n+        club: true,\r\n+      },\r\n+    });\r\n+\r\n+    if (!member) return res.status(404).json({ error: 'Member not found' });\r\n+\r\n+    res.json(member);\r\n+  } catch (err) {\r\n+    console.error('Fetch member detail error:', err);\r\n+    res.status(500).json({ error: 'Failed to fetch member details' });\r\n+  }\r\n+});\r\n+\r\n+\r\n+\r\n export default router;\r\n"
                },
                {
                    "date": 1752292982034,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -0,0 +1,173 @@\n+import express from 'express';\r\n+import { PrismaClient } from '@prisma/client';\r\n+import { Request, Response } from 'express';\r\n+\r\n+const router = express.Router();\r\n+const prisma = new PrismaClient();\r\n+\r\n+router.post('/', async (req, res) => {\r\n+  try {\r\n+    const {\r\n+      firstName, lastName, email, phone, work, dateOfBirth, gender, avatar,\r\n+      club, keyFob, tags, note, memberType,\r\n+      address, marketing, additional, emergency,\r\n+      medicalInfo,\r\n+    } = req.body;\r\n+\r\n+    const newMember = await prisma.member.create({\r\n+      data: {\r\n+        firstName,\r\n+        lastName,\r\n+        email,\r\n+        phone,\r\n+        work,\r\n+        dateOfBirth: dateOfBirth ? new Date(dateOfBirth) : null,\r\n+        gender,\r\n+        avatarUrl: avatar || null,\r\n+        keyFob,\r\n+        tags,\r\n+        note,\r\n+        memberType,\r\n+\r\n+        // Address\r\n+        street: address?.street || null,\r\n+        city: address?.city || null,\r\n+        state: address?.state || null,\r\n+        zip: address?.zip || null,\r\n+        addressSearch: address?.search || null,\r\n+\r\n+        // Marketing\r\n+        salesRep: marketing?.salesRep || null,\r\n+        sourcePromotion: marketing?.sourcePromotion || null,\r\n+        referredBy: marketing?.referredBy || null,\r\n+\r\n+        // Additional\r\n+        trainerId: additional?.trainerId || null,\r\n+        joiningDate: additional?.joiningDate ? new Date(additional.joiningDate) : null,\r\n+        occupation: additional?.occupation || null,\r\n+        organization: additional?.organization || null,\r\n+        involvementType: additional?.involvementType || null,\r\n+\r\n+        // Emergency\r\n+        emergencyName: emergency?.name || null,\r\n+        emergencyRelationship: emergency?.relationship || null,\r\n+        emergencyPhone: emergency?.phone || null,\r\n+        emergencyEmail: emergency?.email || null,\r\n+\r\n+        medicalInfo,\r\n+        clubId: club,\r\n+      },\r\n+    });\r\n+\r\n+    res.status(201).json(newMember);\r\n+  } catch (err) {\r\n+    console.error('Add Member Error:', err);\r\n+    res.status(500).json({ error: 'Failed to create member' });\r\n+  }\r\n+});\r\n+\r\n+router.get('/', async (req, res) => {\r\n+  try {\r\n+    const { tab = 'all', search = '', page = 1, limit = 10, clubId } = req.query;\r\n+    const skip = (Number(page) - 1) * Number(limit);\r\n+\r\n+    let whereClause: any = {\r\n+      clubId: String(clubId),\r\n+    };\r\n+\r\n+    if (search) {\r\n+      whereClause.OR = [\r\n+        { firstName: { contains: search, mode: 'insensitive' } },\r\n+        { lastName: { contains: search, mode: 'insensitive' } },\r\n+        { email: { contains: search, mode: 'insensitive' } },\r\n+      ];\r\n+    }\r\n+\r\n+    switch (tab) {\r\n+      case 'active':\r\n+        whereClause.memberType = 'member';\r\n+        break;\r\n+      case 'expired':\r\n+        whereClause.memberType = 'member';\r\n+        whereClause.keyFob = null;\r\n+        break;\r\n+      case 'prospect':\r\n+        whereClause.memberType = 'prospect';\r\n+        break;\r\n+      case 'recent':\r\n+        const thirtyDaysAgo = new Date();\r\n+        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);\r\n+        whereClause.createdAt = { gte: thirtyDaysAgo };\r\n+        break;\r\n+      default:\r\n+        break;\r\n+    }\r\n+\r\n+    const [members, total] = await Promise.all([\r\n+      prisma.member.findMany({\r\n+        where: whereClause,\r\n+        orderBy: { createdAt: 'desc' },\r\n+        skip,\r\n+        take: Number(limit),\r\n+      }),\r\n+      prisma.member.count({ where: whereClause }),\r\n+    ]);\r\n+\r\n+    res.json({\r\n+      data: members,\r\n+      meta: {\r\n+        total,\r\n+        page: Number(page),\r\n+        pageSize: Number(limit),\r\n+      },\r\n+    });\r\n+  } catch (err) {\r\n+    console.error(err);\r\n+    res.status(500).json({ error: 'Failed to fetch members' });\r\n+  }\r\n+});\r\n+\r\n+// GET /api/members/:id\r\n+router.get('/:id', async (req, res) => {\r\n+  const { id } = req.params;\r\n+\r\n+  try {\r\n+    const member = await prisma.member.findUnique({\r\n+      where: { id },\r\n+      include: {\r\n+        trainer: true,\r\n+        club: true,\r\n+      },\r\n+    });\r\n+\r\n+    if (!member) return res.status(404).json({ error: 'Member not found' });\r\n+\r\n+    res.json(member);\r\n+  } catch (err) {\r\n+    console.error('Fetch member detail error:', err);\r\n+    res.status(500).json({ error: 'Failed to fetch member details' });\r\n+  }\r\n+});\r\n+\r\n+//update member\r\n+\r\n+export const updateMemberById = async (req: Request, res: Response) => {\r\n+  try {\r\n+    const { id } = req.params;\r\n+    const updatedData = req.body;\r\n+\r\n+    const updated = await prisma.member.update({\r\n+      where: { id },\r\n+      data: updatedData\r\n+    });\r\n+\r\n+    return res.status(200).json(updated);\r\n+  } catch (err) {\r\n+    console.error('Error updating member:', err);\r\n+    return res.status(500).json({ error: 'Failed to update member' });\r\n+  }\r\n+};\r\n+\r\n+\r\n+\r\n+export default router;\r\n"
                },
                {
                    "date": 1752293244097,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -150,177 +150,67 @@\n });\r\n \r\n //update member\r\n \r\n-export const updateMemberById = async (req: Request, res: Response) => {\r\n+// PUT /api/members/:id\r\n+router.put('/:id', async (req: Request, res: Response) => {\r\n   try {\r\n     const { id } = req.params;\r\n     const updatedData = req.body;\r\n \r\n     const updated = await prisma.member.update({\r\n       where: { id },\r\n-      data: updatedData\r\n-    });\r\n-\r\n-    return res.status(200).json(updated);\r\n-  } catch (err) {\r\n-    console.error('Error updating member:', err);\r\n-    return res.status(500).json({ error: 'Failed to update member' });\r\n-  }\r\n-};\r\n-\r\n-\r\n-\r\n-export default router;\r\n-import express from 'express';\r\n-import { PrismaClient } from '@prisma/client';\r\n-\r\n-const router = express.Router();\r\n-const prisma = new PrismaClient();\r\n-\r\n-router.post('/', async (req, res) => {\r\n-  try {\r\n-    const {\r\n-      firstName, lastName, email, phone, work, dateOfBirth, gender, avatar,\r\n-      club, keyFob, tags, note, memberType,\r\n-      address, marketing, additional, emergency,\r\n-      medicalInfo,\r\n-    } = req.body;\r\n-\r\n-    const newMember = await prisma.member.create({\r\n       data: {\r\n-        firstName,\r\n-        lastName,\r\n-        email,\r\n-        phone,\r\n-        work,\r\n-        dateOfBirth: dateOfBirth ? new Date(dateOfBirth) : null,\r\n-        gender,\r\n-        avatarUrl: avatar || null,\r\n-        keyFob,\r\n-        tags,\r\n-        note,\r\n-        memberType,\r\n+        firstName: updatedData.firstName,\r\n+        lastName: updatedData.lastName,\r\n+        email: updatedData.email,\r\n+        phone: updatedData.phone,\r\n+        work: updatedData.work,\r\n+        dateOfBirth: updatedData.dateOfBirth ? new Date(updatedData.dateOfBirth) : null,\r\n+        gender: updatedData.gender,\r\n+        avatarUrl: updatedData.avatar || null,\r\n+        keyFob: updatedData.keyFob,\r\n+        tags: updatedData.tags,\r\n+        note: updatedData.note,\r\n+        memberType: updatedData.memberType,\r\n \r\n         // Address\r\n-        street: address?.street || null,\r\n-        city: address?.city || null,\r\n-        state: address?.state || null,\r\n-        zip: address?.zip || null,\r\n-        addressSearch: address?.search || null,\r\n+        street: updatedData.address?.street || null,\r\n+        city: updatedData.address?.city || null,\r\n+        state: updatedData.address?.state || null,\r\n+        zip: updatedData.address?.zip || null,\r\n+        addressSearch: updatedData.address?.search || null,\r\n \r\n         // Marketing\r\n-        salesRep: marketing?.salesRep || null,\r\n-        sourcePromotion: marketing?.sourcePromotion || null,\r\n-        referredBy: marketing?.referredBy || null,\r\n+        salesRep: updatedData.marketing?.salesRep || null,\r\n+        sourcePromotion: updatedData.marketing?.sourcePromotion || null,\r\n+        referredBy: updatedData.marketing?.referredBy || null,\r\n \r\n         // Additional\r\n-        trainerId: additional?.trainerId || null,\r\n-        joiningDate: additional?.joiningDate ? new Date(additional.joiningDate) : null,\r\n-        occupation: additional?.occupation || null,\r\n-        organization: additional?.organization || null,\r\n-        involvementType: additional?.involvementType || null,\r\n+        trainerId: updatedData.additional?.trainerId || null,\r\n+        joiningDate: updatedData.additional?.joiningDate ? new Date(updatedData.additional.joiningDate) : null,\r\n+        occupation: updatedData.additional?.occupation || null,\r\n+        organization: updatedData.additional?.organization || null,\r\n+        involvementType: updatedData.additional?.involvementType || null,\r\n \r\n         // Emergency\r\n-        emergencyName: emergency?.name || null,\r\n-        emergencyRelationship: emergency?.relationship || null,\r\n-        emergencyPhone: emergency?.phone || null,\r\n-        emergencyEmail: emergency?.email || null,\r\n+        emergencyName: updatedData.emergency?.name || null,\r\n+        emergencyRelationship: updatedData.emergency?.relationship || null,\r\n+        emergencyPhone: updatedData.emergency?.phone || null,\r\n+        emergencyEmail: updatedData.emergency?.email || null,\r\n \r\n-        medicalInfo,\r\n-        clubId: club,\r\n+        medicalInfo: updatedData.medicalInfo,\r\n+        clubId: updatedData.club,\r\n       },\r\n     });\r\n \r\n-    res.status(201).json(newMember);\r\n+    return res.status(200).json(updated);\r\n   } catch (err) {\r\n-    console.error('Add Member Error:', err);\r\n-    res.status(500).json({ error: 'Failed to create member' });\r\n+    console.error('Error updating member:', err);\r\n+    return res.status(500).json({ error: 'Failed to update member' });\r\n   }\r\n });\r\n \r\n-router.get('/', async (req, res) => {\r\n-  try {\r\n-    const { tab = 'all', search = '', page = 1, limit = 10, clubId } = req.query;\r\n-    const skip = (Number(page) - 1) * Number(limit);\r\n \r\n-    let whereClause: any = {\r\n-      clubId: String(clubId),\r\n-    };\r\n \r\n-    if (search) {\r\n-      whereClause.OR = [\r\n-        { firstName: { contains: search, mode: 'insensitive' } },\r\n-        { lastName: { contains: search, mode: 'insensitive' } },\r\n-        { email: { contains: search, mode: 'insensitive' } },\r\n-      ];\r\n-    }\r\n \r\n-    switch (tab) {\r\n-      case 'active':\r\n-        whereClause.memberType = 'member';\r\n-        break;\r\n-      case 'expired':\r\n-        whereClause.memberType = 'member';\r\n-        whereClause.keyFob = null;\r\n-        break;\r\n-      case 'prospect':\r\n-        whereClause.memberType = 'prospect';\r\n-        break;\r\n-      case 'recent':\r\n-        const thirtyDaysAgo = new Date();\r\n-        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);\r\n-        whereClause.createdAt = { gte: thirtyDaysAgo };\r\n-        break;\r\n-      default:\r\n-        break;\r\n-    }\r\n-\r\n-    const [members, total] = await Promise.all([\r\n-      prisma.member.findMany({\r\n-        where: whereClause,\r\n-        orderBy: { createdAt: 'desc' },\r\n-        skip,\r\n-        take: Number(limit),\r\n-      }),\r\n-      prisma.member.count({ where: whereClause }),\r\n-    ]);\r\n-\r\n-    res.json({\r\n-      data: members,\r\n-      meta: {\r\n-        total,\r\n-        page: Number(page),\r\n-        pageSize: Number(limit),\r\n-      },\r\n-    });\r\n-  } catch (err) {\r\n-    console.error(err);\r\n-    res.status(500).json({ error: 'Failed to fetch members' });\r\n-  }\r\n-});\r\n-\r\n-// GET /api/members/:id\r\n-router.get('/:id', async (req, res) => {\r\n-  const { id } = req.params;\r\n-\r\n-  try {\r\n-    const member = await prisma.member.findUnique({\r\n-      where: { id },\r\n-      include: {\r\n-        trainer: true,\r\n-        club: true,\r\n-      },\r\n-    });\r\n-\r\n-    if (!member) return res.status(404).json({ error: 'Member not found' });\r\n-\r\n-    res.json(member);\r\n-  } catch (err) {\r\n-    console.error('Fetch member detail error:', err);\r\n-    res.status(500).json({ error: 'Failed to fetch member details' });\r\n-  }\r\n-});\r\n-\r\n-\r\n-\r\n export default router;\r\n"
                },
                {
                    "date": 1752294039463,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -4,63 +4,73 @@\n \r\n const router = express.Router();\r\n const prisma = new PrismaClient();\r\n \r\n-router.post('/', async (req, res) => {\r\n-  try {\r\n-    const {\r\n-      firstName, lastName, email, phone, work, dateOfBirth, gender, avatar,\r\n-      club, keyFob, tags, note, memberType,\r\n-      address, marketing, additional, emergency,\r\n-      medicalInfo,\r\n-    } = req.body;\r\n+// router.post('/', async (req, res) => {\r\n+//   try {\r\n+//     const {\r\n+//       firstName, lastName, email, phone, work, dateOfBirth, gender, avatar,\r\n+//       club, keyFob, tags, note, memberType,\r\n+//       address, marketing, additional, emergency,\r\n+//       medicalInfo,\r\n+//     } = req.body;\r\n \r\n-    const newMember = await prisma.member.create({\r\n-      data: {\r\n-        firstName,\r\n-        lastName,\r\n-        email,\r\n-        phone,\r\n-        work,\r\n-        dateOfBirth: dateOfBirth ? new Date(dateOfBirth) : null,\r\n-        gender,\r\n-        avatarUrl: avatar || null,\r\n-        keyFob,\r\n-        tags,\r\n-        note,\r\n-        memberType,\r\n+//     const newMember = await prisma.member.create({\r\n+//       data: {\r\n+//         firstName,\r\n+//         lastName,\r\n+//         email,\r\n+//         phone,\r\n+//         work,\r\n+//         dateOfBirth: dateOfBirth ? new Date(dateOfBirth) : null,\r\n+//         gender,\r\n+//         avatarUrl: avatar || null,\r\n+//         keyFob,\r\n+//         tags,\r\n+//         note,\r\n+//         memberType,\r\n \r\n-        // Address\r\n-        street: address?.street || null,\r\n-        city: address?.city || null,\r\n-        state: address?.state || null,\r\n-        zip: address?.zip || null,\r\n-        addressSearch: address?.search || null,\r\n+//         // Address\r\n+//         street: address?.street || null,\r\n+//         city: address?.city || null,\r\n+//         state: address?.state || null,\r\n+//         zip: address?.zip || null,\r\n+//         addressSearch: address?.search || null,\r\n \r\n-        // Marketing\r\n-        salesRep: marketing?.salesRep || null,\r\n-        sourcePromotion: marketing?.sourcePromotion || null,\r\n-        referredBy: marketing?.referredBy || null,\r\n+//         // Marketing\r\n+//         salesRep: marketing?.salesRep || null,\r\n+//         sourcePromotion: marketing?.sourcePromotion || null,\r\n+//         referredBy: marketing?.referredBy || null,\r\n \r\n-        // Additional\r\n-        trainerId: additional?.trainerId || null,\r\n-        joiningDate: additional?.joiningDate ? new Date(additional.joiningDate) : null,\r\n-        occupation: additional?.occupation || null,\r\n-        organization: additional?.organization || null,\r\n-        involvementType: additional?.involvementType || null,\r\n+//         // Additional\r\n+//         trainerId: additional?.trainerId || null,\r\n+//         joiningDate: additional?.joiningDate ? new Date(additional.joiningDate) : null,\r\n+//         occupation: additional?.occupation || null,\r\n+//         organization: additional?.organization || null,\r\n+//         involvementType: additional?.involvementType || null,\r\n \r\n-        // Emergency\r\n-        emergencyName: emergency?.name || null,\r\n-        emergencyRelationship: emergency?.relationship || null,\r\n-        emergencyPhone: emergency?.phone || null,\r\n-        emergencyEmail: emergency?.email || null,\r\n+//         // Emergency\r\n+//         emergencyName: emergency?.name || null,\r\n+//         emergencyRelationship: emergency?.relationship || null,\r\n+//         emergencyPhone: emergency?.phone || null,\r\n+//         emergencyEmail: emergency?.email || null,\r\n \r\n-        medicalInfo,\r\n-        clubId: club,\r\n-      },\r\n-    });\r\n+//         medicalInfo,\r\n+//         clubId: club,\r\n+//       },\r\n+//     });\r\n \r\n-    res.status(201).json(newMember);\r\n+//     res.status(201).json(newMember);\r\n+//   } catch (err) {\r\n+//     console.error('Add Member Error:', err);\r\n+//     res.status(500).json({ error: 'Failed to create member' });\r\n+//   }\r\n+// });\r\n+\r\n+router.post('/', async (req, res) => {\r\n+  try {\r\n+    console.log('ðŸ“¦ Incoming Payload:', JSON.stringify(req.body, null, 2));\r\n+    return res.status(200).json({ msg: 'Received for debugging' }); // â›” don't create yet\r\n   } catch (err) {\r\n     console.error('Add Member Error:', err);\r\n     res.status(500).json({ error: 'Failed to create member' });\r\n   }\r\n"
                },
                {
                    "date": 1752294658831,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,76 +1,67 @@\n+//src>routes>member.routes.ts\r\n import express from 'express';\r\n import { PrismaClient } from '@prisma/client';\r\n import { Request, Response } from 'express';\r\n \r\n const router = express.Router();\r\n const prisma = new PrismaClient();\r\n \r\n-// router.post('/', async (req, res) => {\r\n-//   try {\r\n-//     const {\r\n-//       firstName, lastName, email, phone, work, dateOfBirth, gender, avatar,\r\n-//       club, keyFob, tags, note, memberType,\r\n-//       address, marketing, additional, emergency,\r\n-//       medicalInfo,\r\n-//     } = req.body;\r\n+router.post('/', async (req, res) => {\r\n+  try {\r\n+    const {\r\n+      firstName, lastName, email, phone, work, dateOfBirth, gender, avatar,\r\n+      club, keyFob, tags, note, memberType,\r\n+      address, marketing, additional, emergency,\r\n+      medicalInfo,\r\n+    } = req.body;\r\n \r\n-//     const newMember = await prisma.member.create({\r\n-//       data: {\r\n-//         firstName,\r\n-//         lastName,\r\n-//         email,\r\n-//         phone,\r\n-//         work,\r\n-//         dateOfBirth: dateOfBirth ? new Date(dateOfBirth) : null,\r\n-//         gender,\r\n-//         avatarUrl: avatar || null,\r\n-//         keyFob,\r\n-//         tags,\r\n-//         note,\r\n-//         memberType,\r\n+    const newMember = await prisma.member.create({\r\n+      data: {\r\n+        firstName,\r\n+        lastName,\r\n+        email,\r\n+        phone,\r\n+        work,\r\n+        dateOfBirth: dateOfBirth ? new Date(dateOfBirth) : null,\r\n+        gender,\r\n+        avatarUrl: avatar || null,\r\n+        keyFob,\r\n+        tags,\r\n+        note,\r\n+        memberType,\r\n \r\n-//         // Address\r\n-//         street: address?.street || null,\r\n-//         city: address?.city || null,\r\n-//         state: address?.state || null,\r\n-//         zip: address?.zip || null,\r\n-//         addressSearch: address?.search || null,\r\n+        // Address\r\n+        street: address?.street || null,\r\n+        city: address?.city || null,\r\n+        state: address?.state || null,\r\n+        zip: address?.zip || null,\r\n+        addressSearch: address?.search || null,\r\n \r\n-//         // Marketing\r\n-//         salesRep: marketing?.salesRep || null,\r\n-//         sourcePromotion: marketing?.sourcePromotion || null,\r\n-//         referredBy: marketing?.referredBy || null,\r\n+        // Marketing\r\n+        salesRep: marketing?.salesRep || null,\r\n+        sourcePromotion: marketing?.sourcePromotion || null,\r\n+        referredBy: marketing?.referredBy || null,\r\n \r\n-//         // Additional\r\n-//         trainerId: additional?.trainerId || null,\r\n-//         joiningDate: additional?.joiningDate ? new Date(additional.joiningDate) : null,\r\n-//         occupation: additional?.occupation || null,\r\n-//         organization: additional?.organization || null,\r\n-//         involvementType: additional?.involvementType || null,\r\n+        // Additional\r\n+        trainerId: additional?.trainerId || null,\r\n+        joiningDate: additional?.joiningDate ? new Date(additional.joiningDate) : null,\r\n+        occupation: additional?.occupation || null,\r\n+        organization: additional?.organization || null,\r\n+        involvementType: additional?.involvementType || null,\r\n \r\n-//         // Emergency\r\n-//         emergencyName: emergency?.name || null,\r\n-//         emergencyRelationship: emergency?.relationship || null,\r\n-//         emergencyPhone: emergency?.phone || null,\r\n-//         emergencyEmail: emergency?.email || null,\r\n+        // Emergency\r\n+        emergencyName: emergency?.name || null,\r\n+        emergencyRelationship: emergency?.relationship || null,\r\n+        emergencyPhone: emergency?.phone || null,\r\n+        emergencyEmail: emergency?.email || null,\r\n \r\n-//         medicalInfo,\r\n-//         clubId: club,\r\n-//       },\r\n-//     });\r\n+        medicalInfo,\r\n+        clubId: club,\r\n+      },\r\n+    });\r\n \r\n-//     res.status(201).json(newMember);\r\n-//   } catch (err) {\r\n-//     console.error('Add Member Error:', err);\r\n-//     res.status(500).json({ error: 'Failed to create member' });\r\n-//   }\r\n-// });\r\n-\r\n-router.post('/', async (req, res) => {\r\n-  try {\r\n-    console.log('ðŸ“¦ Incoming Payload:', JSON.stringify(req.body, null, 2));\r\n-    return res.status(200).json({ msg: 'Received for debugging' }); // â›” don't create yet\r\n+    res.status(201).json(newMember);\r\n   } catch (err) {\r\n     console.error('Add Member Error:', err);\r\n     res.status(500).json({ error: 'Failed to create member' });\r\n   }\r\n"
                },
                {
                    "date": 1752295610638,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -137,8 +137,9 @@\n       where: { id },\r\n       include: {\r\n         trainer: true,\r\n         club: true,\r\n+        membership:true,\r\n       },\r\n     });\r\n \r\n     if (!member) return res.status(404).json({ error: 'Member not found' });\r\n"
                },
                {
                    "date": 1752297450886,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -66,8 +66,34 @@\n     res.status(500).json({ error: 'Failed to create member' });\r\n   }\r\n });\r\n \r\n+// Add membership to a Member\r\n+\r\n+router.post('/:id/membership', async (req, res) => {\r\n+  try {\r\n+    const { id } = req.params;\r\n+    const { planName, startDate, endDate, autoRenew, status } = req.body;\r\n+\r\n+    const membership = await prisma.membership.create({\r\n+      data: {\r\n+        planName,\r\n+        startDate: new Date(startDate),\r\n+        endDate: new Date(endDate),\r\n+        autoRenew,\r\n+        status,\r\n+        memberId: id,\r\n+      },\r\n+    });\r\n+\r\n+    res.status(201).json(membership);\r\n+  } catch (err) {\r\n+    console.error('Add Membership Error:', err);\r\n+    res.status(500).json({ error: 'Failed to create membership' });\r\n+  }\r\n+});\r\n+\r\n+\r\n router.get('/', async (req, res) => {\r\n   try {\r\n     const { tab = 'all', search = '', page = 1, limit = 10, clubId } = req.query;\r\n     const skip = (Number(page) - 1) * Number(limit);\r\n"
                },
                {
                    "date": 1752298161037,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -73,8 +73,18 @@\n   try {\r\n     const { id } = req.params;\r\n     const { planName, startDate, endDate, autoRenew, status } = req.body;\r\n \r\n+    \r\n+    console.log('Received membership data:', {\r\n+      id,\r\n+      planName,\r\n+      startDate,\r\n+      endDate,\r\n+      autoRenew,\r\n+      status\r\n+    })\r\n+\r\n     const membership = await prisma.membership.create({\r\n       data: {\r\n         planName,\r\n         startDate: new Date(startDate),\r\n"
                },
                {
                    "date": 1752372770004,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -73,9 +73,9 @@\n   try {\r\n     const { id } = req.params;\r\n     const { planName, startDate, endDate, autoRenew, status } = req.body;\r\n \r\n-    \r\n+    const price = 5000;\r\n     console.log('Received membership data:', {\r\n       id,\r\n       planName,\r\n       startDate,\r\n@@ -94,8 +94,19 @@\n         memberId: id,\r\n       },\r\n     });\r\n \r\n+    await prisma.invoice.create({\r\n+  data: {\r\n+    memberId: id,\r\n+    planName,\r\n+    amount: price,\r\n+    status: 'unpaid',\r\n+    issuedAt: new Date(),\r\n+    dueDate: new Date(new Date().setDate(new Date().getDate() + 7)),\r\n+  },\r\n+});\r\n+\r\n     res.status(201).json(membership);\r\n   } catch (err) {\r\n     console.error('Add Membership Error:', err);\r\n     res.status(500).json({ error: 'Failed to create membership' });\r\n"
                },
                {
                    "date": 1752373338038,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -73,18 +73,18 @@\n   try {\r\n     const { id } = req.params;\r\n     const { planName, startDate, endDate, autoRenew, status } = req.body;\r\n \r\n-    const price = 5000;\r\n-    console.log('Received membership data:', {\r\n-      id,\r\n-      planName,\r\n-      startDate,\r\n-      endDate,\r\n-      autoRenew,\r\n-      status\r\n-    })\r\n+    const plan = await prisma.membershipPlan.findUnique({\r\n+  where: { name: planName },\r\n+});\r\n+if (!plan) {\r\n+  return res.status(400).json({ error: 'Invalid plan selected' });\r\n+}\r\n \r\n+\r\n+    \r\n+\r\n     const membership = await prisma.membership.create({\r\n       data: {\r\n         planName,\r\n         startDate: new Date(startDate),\r\n@@ -98,9 +98,9 @@\n     await prisma.invoice.create({\r\n   data: {\r\n     memberId: id,\r\n     planName,\r\n-    amount: price,\r\n+    amount: plan.price,\r\n     status: 'unpaid',\r\n     issuedAt: new Date(),\r\n     dueDate: new Date(new Date().setDate(new Date().getDate() + 7)),\r\n   },\r\n"
                },
                {
                    "date": 1752393057498,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -49,13 +49,15 @@\n         organization: additional?.organization || null,\r\n         involvementType: additional?.involvementType || null,\r\n \r\n         // Emergency\r\n-        emergencyName: emergency?.name || null,\r\n-        emergencyRelationship: emergency?.relationship || null,\r\n-        emergencyPhone: emergency?.phone || null,\r\n-        emergencyEmail: emergency?.email || null,\r\n+        // emergencyName: emergency?.name || null,\r\n+        // emergencyRelationship: emergency?.relationship || null,\r\n+        // emergencyPhone: emergency?.phone || null,\r\n+        // emergencyEmail: emergency?.email || null,\r\n \r\n+        emergency: emergency || [],\r\n+\r\n         medicalInfo,\r\n         clubId: club,\r\n       },\r\n     });\r\n"
                },
                {
                    "date": 1752393102461,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -243,13 +243,15 @@\n         organization: updatedData.additional?.organization || null,\r\n         involvementType: updatedData.additional?.involvementType || null,\r\n \r\n         // Emergency\r\n-        emergencyName: updatedData.emergency?.name || null,\r\n-        emergencyRelationship: updatedData.emergency?.relationship || null,\r\n-        emergencyPhone: updatedData.emergency?.phone || null,\r\n-        emergencyEmail: updatedData.emergency?.email || null,\r\n+        // emergencyName: updatedData.emergency?.name || null,\r\n+        // emergencyRelationship: updatedData.emergency?.relationship || null,\r\n+        // emergencyPhone: updatedData.emergency?.phone || null,\r\n+        // emergencyEmail: updatedData.emergency?.email || null,\r\n \r\n+        emergency: updatedData.emergency || [],\r\n+\r\n         medicalInfo: updatedData.medicalInfo,\r\n         clubId: updatedData.club,\r\n       },\r\n     });\r\n"
                },
                {
                    "date": 1752395149302,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -250,9 +250,15 @@\n         // emergencyEmail: updatedData.emergency?.email || null,\r\n \r\n         emergency: updatedData.emergency || [],\r\n \r\n-        medicalInfo: updatedData.medicalInfo,\r\n+        medicalInfo: updatedData.medicalInfo || '',\r\n+allergies: updatedData.allergies || '',\r\n+medications: updatedData.medications || '',\r\n+chronicConditions: updatedData.chronicConditions || '',\r\n+injuries: updatedData.injuries || '',\r\n+doctorContact: updatedData.doctorContact || '',\r\n+lastExamDate: updatedData.lastExamDate ? new Date(updatedData.lastExamDate) : null,\r\n         clubId: updatedData.club,\r\n       },\r\n     });\r\n \r\n"
                },
                {
                    "date": 1752395154638,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -0,0 +1,275 @@\n+//src>routes>member.routes.ts\r\n+import express from 'express';\r\n+import { PrismaClient } from '@prisma/client';\r\n+import { Request, Response } from 'express';\r\n+\r\n+const router = express.Router();\r\n+const prisma = new PrismaClient();\r\n+\r\n+router.post('/', async (req, res) => {\r\n+  try {\r\n+    const {\r\n+      firstName, lastName, email, phone, work, dateOfBirth, gender, avatar,\r\n+      club, keyFob, tags, note, memberType,\r\n+      address, marketing, additional, emergency,\r\n+      medicalInfo,\r\n+    } = req.body;\r\n+\r\n+    const newMember = await prisma.member.create({\r\n+      data: {\r\n+        firstName,\r\n+        lastName,\r\n+        email,\r\n+        phone,\r\n+        work,\r\n+        dateOfBirth: dateOfBirth ? new Date(dateOfBirth) : null,\r\n+        gender,\r\n+        avatarUrl: avatar || null,\r\n+        keyFob,\r\n+        tags,\r\n+        note,\r\n+        memberType,\r\n+\r\n+        // Address\r\n+        street: address?.street || null,\r\n+        city: address?.city || null,\r\n+        state: address?.state || null,\r\n+        zip: address?.zip || null,\r\n+        addressSearch: address?.search || null,\r\n+\r\n+        // Marketing\r\n+        salesRep: marketing?.salesRep || null,\r\n+        sourcePromotion: marketing?.sourcePromotion || null,\r\n+        referredBy: marketing?.referredBy || null,\r\n+\r\n+        // Additional\r\n+        trainerId: additional?.trainerId || null,\r\n+        joiningDate: additional?.joiningDate ? new Date(additional.joiningDate) : null,\r\n+        occupation: additional?.occupation || null,\r\n+        organization: additional?.organization || null,\r\n+        involvementType: additional?.involvementType || null,\r\n+\r\n+        // Emergency\r\n+        // emergencyName: emergency?.name || null,\r\n+        // emergencyRelationship: emergency?.relationship || null,\r\n+        // emergencyPhone: emergency?.phone || null,\r\n+        // emergencyEmail: emergency?.email || null,\r\n+\r\n+        emergency: emergency || [],\r\n+\r\n+        medicalInfo,\r\n+        clubId: club,\r\n+      },\r\n+    });\r\n+\r\n+    res.status(201).json(newMember);\r\n+  } catch (err) {\r\n+    console.error('Add Member Error:', err);\r\n+    res.status(500).json({ error: 'Failed to create member' });\r\n+  }\r\n+});\r\n+\r\n+// Add membership to a Member\r\n+\r\n+router.post('/:id/membership', async (req, res) => {\r\n+  try {\r\n+    const { id } = req.params;\r\n+    const { planName, startDate, endDate, autoRenew, status } = req.body;\r\n+\r\n+    const plan = await prisma.membershipPlan.findUnique({\r\n+  where: { name: planName },\r\n+});\r\n+if (!plan) {\r\n+  return res.status(400).json({ error: 'Invalid plan selected' });\r\n+}\r\n+\r\n+\r\n+    \r\n+\r\n+    const membership = await prisma.membership.create({\r\n+      data: {\r\n+        planName,\r\n+        startDate: new Date(startDate),\r\n+        endDate: new Date(endDate),\r\n+        autoRenew,\r\n+        status,\r\n+        memberId: id,\r\n+      },\r\n+    });\r\n+\r\n+    await prisma.invoice.create({\r\n+  data: {\r\n+    memberId: id,\r\n+    planName,\r\n+    amount: plan.price,\r\n+    status: 'unpaid',\r\n+    issuedAt: new Date(),\r\n+    dueDate: new Date(new Date().setDate(new Date().getDate() + 7)),\r\n+  },\r\n+});\r\n+\r\n+    res.status(201).json(membership);\r\n+  } catch (err) {\r\n+    console.error('Add Membership Error:', err);\r\n+    res.status(500).json({ error: 'Failed to create membership' });\r\n+  }\r\n+});\r\n+\r\n+\r\n+router.get('/', async (req, res) => {\r\n+  try {\r\n+    const { tab = 'all', search = '', page = 1, limit = 10, clubId } = req.query;\r\n+    const skip = (Number(page) - 1) * Number(limit);\r\n+\r\n+    let whereClause: any = {\r\n+      clubId: String(clubId),\r\n+    };\r\n+\r\n+    if (search) {\r\n+      whereClause.OR = [\r\n+        { firstName: { contains: search, mode: 'insensitive' } },\r\n+        { lastName: { contains: search, mode: 'insensitive' } },\r\n+        { email: { contains: search, mode: 'insensitive' } },\r\n+      ];\r\n+    }\r\n+\r\n+    switch (tab) {\r\n+      case 'active':\r\n+        whereClause.memberType = 'member';\r\n+        break;\r\n+      case 'expired':\r\n+        whereClause.memberType = 'member';\r\n+        whereClause.keyFob = null;\r\n+        break;\r\n+      case 'prospect':\r\n+        whereClause.memberType = 'prospect';\r\n+        break;\r\n+      case 'recent':\r\n+        const thirtyDaysAgo = new Date();\r\n+        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);\r\n+        whereClause.createdAt = { gte: thirtyDaysAgo };\r\n+        break;\r\n+      default:\r\n+        break;\r\n+    }\r\n+\r\n+    const [members, total] = await Promise.all([\r\n+      prisma.member.findMany({\r\n+        where: whereClause,\r\n+        orderBy: { createdAt: 'desc' },\r\n+        skip,\r\n+        take: Number(limit),\r\n+      }),\r\n+      prisma.member.count({ where: whereClause }),\r\n+    ]);\r\n+\r\n+    res.json({\r\n+      data: members,\r\n+      meta: {\r\n+        total,\r\n+        page: Number(page),\r\n+        pageSize: Number(limit),\r\n+      },\r\n+    });\r\n+  } catch (err) {\r\n+    console.error(err);\r\n+    res.status(500).json({ error: 'Failed to fetch members' });\r\n+  }\r\n+});\r\n+\r\n+// GET /api/members/:id\r\n+router.get('/:id', async (req, res) => {\r\n+  const { id } = req.params;\r\n+\r\n+  try {\r\n+    const member = await prisma.member.findUnique({\r\n+      where: { id },\r\n+      include: {\r\n+        trainer: true,\r\n+        club: true,\r\n+        membership:true,\r\n+      },\r\n+    });\r\n+\r\n+    if (!member) return res.status(404).json({ error: 'Member not found' });\r\n+\r\n+    res.json(member);\r\n+  } catch (err) {\r\n+    console.error('Fetch member detail error:', err);\r\n+    res.status(500).json({ error: 'Failed to fetch member details' });\r\n+  }\r\n+});\r\n+\r\n+//update member\r\n+\r\n+// PUT /api/members/:id\r\n+router.put('/:id', async (req: Request, res: Response) => {\r\n+  try {\r\n+    const { id } = req.params;\r\n+    const updatedData = req.body;\r\n+\r\n+    const updated = await prisma.member.update({\r\n+      where: { id },\r\n+      data: {\r\n+        firstName: updatedData.firstName,\r\n+        lastName: updatedData.lastName,\r\n+        email: updatedData.email,\r\n+        phone: updatedData.phone,\r\n+        work: updatedData.work,\r\n+        dateOfBirth: updatedData.dateOfBirth ? new Date(updatedData.dateOfBirth) : null,\r\n+        gender: updatedData.gender,\r\n+        avatarUrl: updatedData.avatar || null,\r\n+        keyFob: updatedData.keyFob,\r\n+        tags: updatedData.tags,\r\n+        note: updatedData.note,\r\n+        memberType: updatedData.memberType,\r\n+\r\n+        // Address\r\n+        street: updatedData.address?.street || null,\r\n+        city: updatedData.address?.city || null,\r\n+        state: updatedData.address?.state || null,\r\n+        zip: updatedData.address?.zip || null,\r\n+        addressSearch: updatedData.address?.search || null,\r\n+\r\n+        // Marketing\r\n+        salesRep: updatedData.marketing?.salesRep || null,\r\n+        sourcePromotion: updatedData.marketing?.sourcePromotion || null,\r\n+        referredBy: updatedData.marketing?.referredBy || null,\r\n+\r\n+        // Additional\r\n+        trainerId: updatedData.additional?.trainerId || null,\r\n+        joiningDate: updatedData.additional?.joiningDate ? new Date(updatedData.additional.joiningDate) : null,\r\n+        occupation: updatedData.additional?.occupation || null,\r\n+        organization: updatedData.additional?.organization || null,\r\n+        involvementType: updatedData.additional?.involvementType || null,\r\n+\r\n+        // Emergency\r\n+        // emergencyName: updatedData.emergency?.name || null,\r\n+        // emergencyRelationship: updatedData.emergency?.relationship || null,\r\n+        // emergencyPhone: updatedData.emergency?.phone || null,\r\n+        // emergencyEmail: updatedData.emergency?.email || null,\r\n+\r\n+        emergency: updatedData.emergency || [],\r\n+\r\n+        medicalInfo: updatedData.medicalInfo || '',\r\n+allergies: updatedData.allergies || '',\r\n+medications: updatedData.medications || '',\r\n+chronicConditions: updatedData.chronicConditions || '',\r\n+injuries: updatedData.injuries || '',\r\n+doctorContact: updatedData.doctorContact || '',\r\n+lastExamDate: updatedData.lastExamDate ? new Date(updatedData.lastExamDate) : null,\r\n+        clubId: updatedData.club,\r\n+      },\r\n+    });\r\n+\r\n+    return res.status(200).json(updated);\r\n+  } catch (err) {\r\n+    console.error('Error updating member:', err);\r\n+    return res.status(500).json({ error: 'Failed to update member' });\r\n+  }\r\n+});\r\n+\r\n+\r\n+\r\n+\r\n+export default router;\r\n"
                },
                {
                    "date": 1752397145812,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -243,15 +243,10 @@\n         organization: updatedData.additional?.organization || null,\r\n         involvementType: updatedData.additional?.involvementType || null,\r\n \r\n         // Emergency\r\n-        // emergencyName: updatedData.emergency?.name || null,\r\n-        // emergencyRelationship: updatedData.emergency?.relationship || null,\r\n-        // emergencyPhone: updatedData.emergency?.phone || null,\r\n-        // emergencyEmail: updatedData.emergency?.email || null,\r\n-\r\n         emergency: updatedData.emergency || [],\r\n-\r\n+//medical information\r\n         medicalInfo: updatedData.medicalInfo || '',\r\n allergies: updatedData.allergies || '',\r\n medications: updatedData.medications || '',\r\n chronicConditions: updatedData.chronicConditions || '',\r\n@@ -272,279 +267,4 @@\n \r\n \r\n \r\n export default router;\r\n-//src>routes>member.routes.ts\r\n-import express from 'express';\r\n-import { PrismaClient } from '@prisma/client';\r\n-import { Request, Response } from 'express';\r\n-\r\n-const router = express.Router();\r\n-const prisma = new PrismaClient();\r\n-\r\n-router.post('/', async (req, res) => {\r\n-  try {\r\n-    const {\r\n-      firstName, lastName, email, phone, work, dateOfBirth, gender, avatar,\r\n-      club, keyFob, tags, note, memberType,\r\n-      address, marketing, additional, emergency,\r\n-      medicalInfo,\r\n-    } = req.body;\r\n-\r\n-    const newMember = await prisma.member.create({\r\n-      data: {\r\n-        firstName,\r\n-        lastName,\r\n-        email,\r\n-        phone,\r\n-        work,\r\n-        dateOfBirth: dateOfBirth ? new Date(dateOfBirth) : null,\r\n-        gender,\r\n-        avatarUrl: avatar || null,\r\n-        keyFob,\r\n-        tags,\r\n-        note,\r\n-        memberType,\r\n-\r\n-        // Address\r\n-        street: address?.street || null,\r\n-        city: address?.city || null,\r\n-        state: address?.state || null,\r\n-        zip: address?.zip || null,\r\n-        addressSearch: address?.search || null,\r\n-\r\n-        // Marketing\r\n-        salesRep: marketing?.salesRep || null,\r\n-        sourcePromotion: marketing?.sourcePromotion || null,\r\n-        referredBy: marketing?.referredBy || null,\r\n-\r\n-        // Additional\r\n-        trainerId: additional?.trainerId || null,\r\n-        joiningDate: additional?.joiningDate ? new Date(additional.joiningDate) : null,\r\n-        occupation: additional?.occupation || null,\r\n-        organization: additional?.organization || null,\r\n-        involvementType: additional?.involvementType || null,\r\n-\r\n-        // Emergency\r\n-        // emergencyName: emergency?.name || null,\r\n-        // emergencyRelationship: emergency?.relationship || null,\r\n-        // emergencyPhone: emergency?.phone || null,\r\n-        // emergencyEmail: emergency?.email || null,\r\n-\r\n-        emergency: emergency || [],\r\n-\r\n-        medicalInfo,\r\n-        clubId: club,\r\n-      },\r\n-    });\r\n-\r\n-    res.status(201).json(newMember);\r\n-  } catch (err) {\r\n-    console.error('Add Member Error:', err);\r\n-    res.status(500).json({ error: 'Failed to create member' });\r\n-  }\r\n-});\r\n-\r\n-// Add membership to a Member\r\n-\r\n-router.post('/:id/membership', async (req, res) => {\r\n-  try {\r\n-    const { id } = req.params;\r\n-    const { planName, startDate, endDate, autoRenew, status } = req.body;\r\n-\r\n-    const plan = await prisma.membershipPlan.findUnique({\r\n-  where: { name: planName },\r\n-});\r\n-if (!plan) {\r\n-  return res.status(400).json({ error: 'Invalid plan selected' });\r\n-}\r\n-\r\n-\r\n-    \r\n-\r\n-    const membership = await prisma.membership.create({\r\n-      data: {\r\n-        planName,\r\n-        startDate: new Date(startDate),\r\n-        endDate: new Date(endDate),\r\n-        autoRenew,\r\n-        status,\r\n-        memberId: id,\r\n-      },\r\n-    });\r\n-\r\n-    await prisma.invoice.create({\r\n-  data: {\r\n-    memberId: id,\r\n-    planName,\r\n-    amount: plan.price,\r\n-    status: 'unpaid',\r\n-    issuedAt: new Date(),\r\n-    dueDate: new Date(new Date().setDate(new Date().getDate() + 7)),\r\n-  },\r\n-});\r\n-\r\n-    res.status(201).json(membership);\r\n-  } catch (err) {\r\n-    console.error('Add Membership Error:', err);\r\n-    res.status(500).json({ error: 'Failed to create membership' });\r\n-  }\r\n-});\r\n-\r\n-\r\n-router.get('/', async (req, res) => {\r\n-  try {\r\n-    const { tab = 'all', search = '', page = 1, limit = 10, clubId } = req.query;\r\n-    const skip = (Number(page) - 1) * Number(limit);\r\n-\r\n-    let whereClause: any = {\r\n-      clubId: String(clubId),\r\n-    };\r\n-\r\n-    if (search) {\r\n-      whereClause.OR = [\r\n-        { firstName: { contains: search, mode: 'insensitive' } },\r\n-        { lastName: { contains: search, mode: 'insensitive' } },\r\n-        { email: { contains: search, mode: 'insensitive' } },\r\n-      ];\r\n-    }\r\n-\r\n-    switch (tab) {\r\n-      case 'active':\r\n-        whereClause.memberType = 'member';\r\n-        break;\r\n-      case 'expired':\r\n-        whereClause.memberType = 'member';\r\n-        whereClause.keyFob = null;\r\n-        break;\r\n-      case 'prospect':\r\n-        whereClause.memberType = 'prospect';\r\n-        break;\r\n-      case 'recent':\r\n-        const thirtyDaysAgo = new Date();\r\n-        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);\r\n-        whereClause.createdAt = { gte: thirtyDaysAgo };\r\n-        break;\r\n-      default:\r\n-        break;\r\n-    }\r\n-\r\n-    const [members, total] = await Promise.all([\r\n-      prisma.member.findMany({\r\n-        where: whereClause,\r\n-        orderBy: { createdAt: 'desc' },\r\n-        skip,\r\n-        take: Number(limit),\r\n-      }),\r\n-      prisma.member.count({ where: whereClause }),\r\n-    ]);\r\n-\r\n-    res.json({\r\n-      data: members,\r\n-      meta: {\r\n-        total,\r\n-        page: Number(page),\r\n-        pageSize: Number(limit),\r\n-      },\r\n-    });\r\n-  } catch (err) {\r\n-    console.error(err);\r\n-    res.status(500).json({ error: 'Failed to fetch members' });\r\n-  }\r\n-});\r\n-\r\n-// GET /api/members/:id\r\n-router.get('/:id', async (req, res) => {\r\n-  const { id } = req.params;\r\n-\r\n-  try {\r\n-    const member = await prisma.member.findUnique({\r\n-      where: { id },\r\n-      include: {\r\n-        trainer: true,\r\n-        club: true,\r\n-        membership:true,\r\n-      },\r\n-    });\r\n-\r\n-    if (!member) return res.status(404).json({ error: 'Member not found' });\r\n-\r\n-    res.json(member);\r\n-  } catch (err) {\r\n-    console.error('Fetch member detail error:', err);\r\n-    res.status(500).json({ error: 'Failed to fetch member details' });\r\n-  }\r\n-});\r\n-\r\n-//update member\r\n-\r\n-// PUT /api/members/:id\r\n-router.put('/:id', async (req: Request, res: Response) => {\r\n-  try {\r\n-    const { id } = req.params;\r\n-    const updatedData = req.body;\r\n-\r\n-    const updated = await prisma.member.update({\r\n-      where: { id },\r\n-      data: {\r\n-        firstName: updatedData.firstName,\r\n-        lastName: updatedData.lastName,\r\n-        email: updatedData.email,\r\n-        phone: updatedData.phone,\r\n-        work: updatedData.work,\r\n-        dateOfBirth: updatedData.dateOfBirth ? new Date(updatedData.dateOfBirth) : null,\r\n-        gender: updatedData.gender,\r\n-        avatarUrl: updatedData.avatar || null,\r\n-        keyFob: updatedData.keyFob,\r\n-        tags: updatedData.tags,\r\n-        note: updatedData.note,\r\n-        memberType: updatedData.memberType,\r\n-\r\n-        // Address\r\n-        street: updatedData.address?.street || null,\r\n-        city: updatedData.address?.city || null,\r\n-        state: updatedData.address?.state || null,\r\n-        zip: updatedData.address?.zip || null,\r\n-        addressSearch: updatedData.address?.search || null,\r\n-\r\n-        // Marketing\r\n-        salesRep: updatedData.marketing?.salesRep || null,\r\n-        sourcePromotion: updatedData.marketing?.sourcePromotion || null,\r\n-        referredBy: updatedData.marketing?.referredBy || null,\r\n-\r\n-        // Additional\r\n-        trainerId: updatedData.additional?.trainerId || null,\r\n-        joiningDate: updatedData.additional?.joiningDate ? new Date(updatedData.additional.joiningDate) : null,\r\n-        occupation: updatedData.additional?.occupation || null,\r\n-        organization: updatedData.additional?.organization || null,\r\n-        involvementType: updatedData.additional?.involvementType || null,\r\n-\r\n-        // Emergency\r\n-        // emergencyName: updatedData.emergency?.name || null,\r\n-        // emergencyRelationship: updatedData.emergency?.relationship || null,\r\n-        // emergencyPhone: updatedData.emergency?.phone || null,\r\n-        // emergencyEmail: updatedData.emergency?.email || null,\r\n-\r\n-        emergency: updatedData.emergency || [],\r\n-\r\n-        medicalInfo: updatedData.medicalInfo || '',\r\n-allergies: updatedData.allergies || '',\r\n-medications: updatedData.medications || '',\r\n-chronicConditions: updatedData.chronicConditions || '',\r\n-injuries: updatedData.injuries || '',\r\n-doctorContact: updatedData.doctorContact || '',\r\n-lastExamDate: updatedData.lastExamDate ? new Date(updatedData.lastExamDate) : null,\r\n-        clubId: updatedData.club,\r\n-      },\r\n-    });\r\n-\r\n-    return res.status(200).json(updated);\r\n-  } catch (err) {\r\n-    console.error('Error updating member:', err);\r\n-    return res.status(500).json({ error: 'Failed to update member' });\r\n-  }\r\n-});\r\n-\r\n-\r\n-\r\n-\r\n-export default router;\r\n"
                },
                {
                    "date": 1752397214917,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -49,12 +49,9 @@\n         organization: additional?.organization || null,\r\n         involvementType: additional?.involvementType || null,\r\n \r\n         // Emergency\r\n-        // emergencyName: emergency?.name || null,\r\n-        // emergencyRelationship: emergency?.relationship || null,\r\n-        // emergencyPhone: emergency?.phone || null,\r\n-        // emergencyEmail: emergency?.email || null,\r\n+    \r\n \r\n         emergency: emergency || [],\r\n \r\n         medicalInfo,\r\n@@ -190,8 +187,10 @@\n         membership:true,\r\n       },\r\n     });\r\n \r\n+      console.log('ðŸ‘¨â€âš•ï¸ Full member details:', member); // âœ… ADD THIS\r\n+\r\n     if (!member) return res.status(404).json({ error: 'Member not found' });\r\n \r\n     res.json(member);\r\n   } catch (err) {\r\n"
                },
                {
                    "date": 1752513139915,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -80,10 +80,19 @@\n   return res.status(400).json({ error: 'Invalid plan selected' });\r\n }\r\n \r\n \r\n-    \r\n+    const active = await prisma.membership.findFirst({\r\n+  where: { memberId: id, status: 'active' }\r\n \r\n+});\r\n+\r\n+if (active) {\r\n+  return res.status(400).json({\r\n+    error: 'This member already has an active membership. Please cancel or expire it first.'\r\n+  });\r\n+}\r\n+\r\n     const membership = await prisma.membership.create({\r\n       data: {\r\n         planName,\r\n         startDate: new Date(startDate),\r\n"
                },
                {
                    "date": 1752523912219,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -102,8 +102,17 @@\n         memberId: id,\r\n       },\r\n     });\r\n \r\n+    const member = await prisma.member.findUnique({\r\n+      where: { id },\r\n+      select: { clubId: true },\r\n+    });\r\n+\r\n+    if (!member) {\r\n+      return res.status(404).json({ error: 'Member not found' });\r\n+    }\r\n+\r\n     await prisma.invoice.create({\r\n   data: {\r\n     memberId: id,\r\n     planName,\r\n"
                },
                {
                    "date": 1752523935898,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -117,8 +117,9 @@\n     memberId: id,\r\n     planName,\r\n     amount: plan.price,\r\n     status: 'unpaid',\r\n+    clubId: member.clubId,\r\n     issuedAt: new Date(),\r\n     dueDate: new Date(new Date().setDate(new Date().getDate() + 7)),\r\n   },\r\n });\r\n"
                },
                {
                    "date": 1752527013566,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -67,32 +67,98 @@\n });\r\n \r\n // Add membership to a Member\r\n \r\n+// router.post('/:id/membership', async (req, res) => {\r\n+//   try {\r\n+//     const { id } = req.params;\r\n+//     const { planName, startDate, endDate, autoRenew, status } = req.body;\r\n+\r\n+//     const plan = await prisma.membershipPlan.findUnique({\r\n+//   where: { name: planName },\r\n+// });\r\n+// if (!plan) {\r\n+//   return res.status(400).json({ error: 'Invalid plan selected' });\r\n+// }\r\n+\r\n+\r\n+//     const active = await prisma.membership.findFirst({\r\n+//   where: { memberId: id, status: 'active' }\r\n+\r\n+// });\r\n+\r\n+// if (active) {\r\n+//   return res.status(400).json({\r\n+//     error: 'This member already has an active membership. Please cancel or expire it first.'\r\n+//   });\r\n+// }\r\n+\r\n+//     const membership = await prisma.membership.create({\r\n+//       data: {\r\n+//         planName,\r\n+//         startDate: new Date(startDate),\r\n+//         endDate: new Date(endDate),\r\n+//         autoRenew,\r\n+//         status,\r\n+//         memberId: id,\r\n+//       },\r\n+//     });\r\n+\r\n+//     const member = await prisma.member.findUnique({\r\n+//       where: { id },\r\n+//       select: { clubId: true },\r\n+//     });\r\n+\r\n+//     if (!member) {\r\n+//       return res.status(404).json({ error: 'Member not found' });\r\n+//     }\r\n+\r\n+//     await prisma.invoice.create({\r\n+//   data: {\r\n+//     memberId: id,\r\n+//     planName,\r\n+//     amount: plan.price,\r\n+//     status: 'unpaid',\r\n+//     clubId: member.clubId,\r\n+//     issuedAt: new Date(),\r\n+//     dueDate: new Date(new Date().setDate(new Date().getDate() + 7)),\r\n+//   },\r\n+// });\r\n+\r\n+//     res.status(201).json(membership);\r\n+//   } catch (err) {\r\n+//     console.error('Add Membership Error:', err);\r\n+//     res.status(500).json({ error: 'Failed to create membership' });\r\n+//   }\r\n+// });\r\n+// In your member.routes.ts, update the membership creation route:\r\n+\r\n router.post('/:id/membership', async (req, res) => {\r\n   try {\r\n     const { id } = req.params;\r\n     const { planName, startDate, endDate, autoRenew, status } = req.body;\r\n \r\n+    console.log('Creating membership for member:', id);\r\n+    console.log('Request body:', req.body);\r\n+\r\n     const plan = await prisma.membershipPlan.findUnique({\r\n-  where: { name: planName },\r\n-});\r\n-if (!plan) {\r\n-  return res.status(400).json({ error: 'Invalid plan selected' });\r\n-}\r\n+      where: { name: planName },\r\n+    });\r\n+    \r\n+    if (!plan) {\r\n+      return res.status(400).json({ error: 'Invalid plan selected' });\r\n+    }\r\n \r\n-\r\n     const active = await prisma.membership.findFirst({\r\n-  where: { memberId: id, status: 'active' }\r\n+      where: { memberId: id, status: 'active' }\r\n+    });\r\n \r\n-});\r\n+    if (active) {\r\n+      return res.status(400).json({\r\n+        error: 'This member already has an active membership. Please cancel or expire it first.'\r\n+      });\r\n+    }\r\n \r\n-if (active) {\r\n-  return res.status(400).json({\r\n-    error: 'This member already has an active membership. Please cancel or expire it first.'\r\n-  });\r\n-}\r\n-\r\n     const membership = await prisma.membership.create({\r\n       data: {\r\n         planName,\r\n         startDate: new Date(startDate),\r\n@@ -102,33 +168,78 @@\n         memberId: id,\r\n       },\r\n     });\r\n \r\n+    console.log('Membership created:', membership);\r\n+\r\n+    // Get member details\r\n     const member = await prisma.member.findUnique({\r\n       where: { id },\r\n-      select: { clubId: true },\r\n+      select: { clubId: true, firstName: true, lastName: true },\r\n     });\r\n \r\n+    console.log('Member found:', member);\r\n+\r\n     if (!member) {\r\n       return res.status(404).json({ error: 'Member not found' });\r\n     }\r\n \r\n-    await prisma.invoice.create({\r\n-  data: {\r\n-    memberId: id,\r\n-    planName,\r\n-    amount: plan.price,\r\n-    status: 'unpaid',\r\n-    clubId: member.clubId,\r\n-    issuedAt: new Date(),\r\n-    dueDate: new Date(new Date().setDate(new Date().getDate() + 7)),\r\n-  },\r\n-});\r\n+    if (!member.clubId) {\r\n+      return res.status(400).json({ error: 'Member does not have a clubId assigned' });\r\n+    }\r\n \r\n-    res.status(201).json(membership);\r\n+    // Create invoice with detailed logging\r\n+    console.log('Creating invoice with data:', {\r\n+      memberId: id,\r\n+      planName,\r\n+      amount: plan.price,\r\n+      status: 'unpaid',\r\n+      clubId: member.clubId,\r\n+      issuedAt: new Date(),\r\n+      dueDate: new Date(new Date().setDate(new Date().getDate() + 7)),\r\n+    });\r\n+\r\n+    try {\r\n+      const invoice = await prisma.invoice.create({\r\n+        data: {\r\n+          memberId: id,\r\n+          planName,\r\n+          amount: plan.price,\r\n+          status: 'unpaid',\r\n+          clubId: member.clubId,\r\n+          issuedAt: new Date(),\r\n+          dueDate: new Date(new Date().setDate(new Date().getDate() + 7)),\r\n+        },\r\n+      });\r\n+\r\n+      console.log('Invoice created successfully:', invoice);\r\n+      \r\n+      res.status(201).json({\r\n+        membership,\r\n+        invoice,\r\n+        message: 'Membership and invoice created successfully'\r\n+      });\r\n+      \r\n+    } catch (invoiceError) {\r\n+      console.error('Invoice creation error:', invoiceError);\r\n+      \r\n+      // If invoice creation fails, we might want to rollback the membership\r\n+      await prisma.membership.delete({\r\n+        where: { id: membership.id }\r\n+      });\r\n+      \r\n+      return res.status(500).json({ \r\n+        error: 'Failed to create invoice', \r\n+        details: invoiceError.message \r\n+      });\r\n+    }\r\n+\r\n   } catch (err) {\r\n     console.error('Add Membership Error:', err);\r\n-    res.status(500).json({ error: 'Failed to create membership' });\r\n+    res.status(500).json({ \r\n+      error: 'Failed to create membership',\r\n+      details: err.message \r\n+    });\r\n   }\r\n });\r\n \r\n \r\n"
                },
                {
                    "date": 1752529105999,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -313,9 +313,12 @@\n       where: { id },\r\n       include: {\r\n         trainer: true,\r\n         club: true,\r\n-        membership:true,\r\n+        membership: {\r\n+      orderBy: { startDate: 'desc' }, // Get most recent first\r\n+      take: 1,                        // Optional: only return one latest\r\n+    },\r\n       },\r\n     });\r\n \r\n       console.log('ðŸ‘¨â€âš•ï¸ Full member details:', member); // âœ… ADD THIS\r\n"
                },
                {
                    "date": 1752844787471,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -244,15 +244,19 @@\n \r\n \r\n router.get('/', async (req, res) => {\r\n   try {\r\n-    const { tab = 'all', search = '', page = 1, limit = 10, clubId } = req.query;\r\n+    const { tab = 'all', search = '', page = 1, limit = 10, clubId, trainerId } = req.query;\r\n     const skip = (Number(page) - 1) * Number(limit);\r\n \r\n     let whereClause: any = {\r\n       clubId: String(clubId),\r\n     };\r\n \r\n+    if (trainerId) {\r\n+    whereClause.trainerId = trainerId; // âœ… FILTER BY TRAINER\r\n+  }\r\n+\r\n     if (search) {\r\n       whereClause.OR = [\r\n         { firstName: { contains: search, mode: 'insensitive' } },\r\n         { lastName: { contains: search, mode: 'insensitive' } },\r\n"
                },
                {
                    "date": 1752846320431,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -399,8 +399,33 @@\n     return res.status(500).json({ error: 'Failed to update member' });\r\n   }\r\n });\r\n \r\n+// GET /api/members/:id/sessions - All attendance sessions for a member\r\n+router.get('/:id/sessions', async (req, res) => {\r\n+  const { id } = req.params;\r\n \r\n+  try {\r\n+    const attendanceRecords = await prisma.attendance.findMany({\r\n+      where: { memberId: id },\r\n+      orderBy: { markedAt: 'desc' },\r\n+      include: {\r\n+        schedule: {\r\n+          include: {\r\n+            trainer: { select: { name: true } },\r\n+            location: { select: { name: true } }\r\n+          }\r\n+        }\r\n+      }\r\n+    });\r\n \r\n+    res.json(attendanceRecords);\r\n+  } catch (err) {\r\n+    console.error('Error fetching session history:', err);\r\n+    res.status(500).json({ error: 'Failed to fetch session history' });\r\n+  }\r\n+});\r\n \r\n+\r\n+\r\n+\r\n export default router;\r\n"
                },
                {
                    "date": 1752859795560,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,8 +1,9 @@\n //src>routes>member.routes.ts\r\n import express from 'express';\r\n import { PrismaClient } from '@prisma/client';\r\n import { Request, Response } from 'express';\r\n+import { getMembersByTrainer } from '../controllers/member.controller';\r\n \r\n const router = express.Router();\r\n const prisma = new PrismaClient();\r\n \r\n@@ -424,8 +425,8 @@\n     res.status(500).json({ error: 'Failed to fetch session history' });\r\n   }\r\n });\r\n \r\n+router.get('/', getMembersByTrainer);\r\n \r\n \r\n-\r\n export default router;\r\n"
                },
                {
                    "date": 1752859928992,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -425,8 +425,9 @@\n     res.status(500).json({ error: 'Failed to fetch session history' });\r\n   }\r\n });\r\n \r\n-router.get('/', getMembersByTrainer);\r\n+router.get('/by-trainer', getMembersByTrainer); // âœ… safer route\r\n \r\n \r\n+\r\n export default router;\r\n"
                },
                {
                    "date": 1752859935048,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -425,9 +425,9 @@\n     res.status(500).json({ error: 'Failed to fetch session history' });\r\n   }\r\n });\r\n \r\n-router.get('/by-trainer', getMembersByTrainer); // âœ… safer route\r\n+router.get('/by-trainer', getMembersByTrainer); \r\n \r\n \r\n \r\n export default router;\r\n"
                },
                {
                    "date": 1752860135837,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -6,8 +6,10 @@\n \r\n const router = express.Router();\r\n const prisma = new PrismaClient();\r\n \r\n+router.get('/by-trainer', getMembersByTrainer); \r\n+\r\n router.post('/', async (req, res) => {\r\n   try {\r\n     const {\r\n       firstName, lastName, email, phone, work, dateOfBirth, gender, avatar,\r\n@@ -425,9 +427,9 @@\n     res.status(500).json({ error: 'Failed to fetch session history' });\r\n   }\r\n });\r\n \r\n-router.get('/by-trainer', getMembersByTrainer); \r\n \r\n \r\n \r\n+\r\n export default router;\r\n"
                },
                {
                    "date": 1752936602172,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -68,10 +68,10 @@\n     res.status(500).json({ error: 'Failed to create member' });\r\n   }\r\n });\r\n \r\n-// Add membership to a Member\r\n \r\n+\r\n // router.post('/:id/membership', async (req, res) => {\r\n //   try {\r\n //     const { id } = req.params;\r\n //     const { planName, startDate, endDate, autoRenew, status } = req.body;\r\n@@ -428,8 +428,45 @@\n   }\r\n });\r\n \r\n \r\n+// ðŸ” ADD THIS â€” handles search with ?q= and filters by clubId\r\n+router.get('/search', async (req, res) => {\r\n+  const { q = '', clubId } = req.query;\r\n \r\n+  if (!clubId) {\r\n+    return res.status(400).json({ error: 'Missing clubId' });\r\n+  }\r\n \r\n+  try {\r\n+    const members = await prisma.member.findMany({\r\n+      where: {\r\n+        clubId: String(clubId),\r\n+        OR: [\r\n+          { firstName: { contains: String(q), mode: 'insensitive' } },\r\n+          { lastName: { contains: String(q), mode: 'insensitive' } },\r\n+          { email: { contains: String(q), mode: 'insensitive' } },\r\n+          { keyFob: { contains: String(q), mode: 'insensitive' } },\r\n+        ],\r\n+      },\r\n+      select: {\r\n+        id: true,\r\n+        firstName: true,\r\n+        lastName: true,\r\n+        email: true,\r\n+        keyFob: true,\r\n+      },\r\n+      take: 15,\r\n+    });\r\n \r\n+    res.json(members);\r\n+  } catch (err) {\r\n+    console.error('Search Error:', err);\r\n+    res.status(500).json({ error: 'Failed to search members' });\r\n+  }\r\n+});\r\n+\r\n+\r\n+\r\n+\r\n+\r\n export default router;\r\n"
                },
                {
                    "date": 1752938504824,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -437,28 +437,50 @@\n     return res.status(400).json({ error: 'Missing clubId' });\r\n   }\r\n \r\n   try {\r\n-    const members = await prisma.member.findMany({\r\n-      where: {\r\n-        clubId: String(clubId),\r\n-        OR: [\r\n-          { firstName: { contains: String(q), mode: 'insensitive' } },\r\n-          { lastName: { contains: String(q), mode: 'insensitive' } },\r\n-          { email: { contains: String(q), mode: 'insensitive' } },\r\n-          { keyFob: { contains: String(q), mode: 'insensitive' } },\r\n-        ],\r\n-      },\r\n-      select: {\r\n-        id: true,\r\n-        firstName: true,\r\n-        lastName: true,\r\n-        email: true,\r\n-        keyFob: true,\r\n-      },\r\n-      take: 15,\r\n-    });\r\n+    let members;\r\n \r\n+    if (q.length === 0) {\r\n+      // Return recent active members when no query provided\r\n+      members = await prisma.member.findMany({\r\n+        where: {\r\n+          clubId: String(clubId),\r\n+          memberType: 'member',\r\n+        },\r\n+        select: {\r\n+          id: true,\r\n+          firstName: true,\r\n+          lastName: true,\r\n+          email: true,\r\n+          keyFob: true,\r\n+        },\r\n+        orderBy: { createdAt: 'desc' },\r\n+        take: 10,\r\n+      });\r\n+    } else {\r\n+      // Perform filtered search\r\n+      members = await prisma.member.findMany({\r\n+        where: {\r\n+          clubId: String(clubId),\r\n+          OR: [\r\n+            { firstName: { contains: String(q), mode: 'insensitive' } },\r\n+            { lastName: { contains: String(q), mode: 'insensitive' } },\r\n+            { email: { contains: String(q), mode: 'insensitive' } },\r\n+            { keyFob: { contains: String(q), mode: 'insensitive' } },\r\n+          ],\r\n+        },\r\n+        select: {\r\n+          id: true,\r\n+          firstName: true,\r\n+          lastName: true,\r\n+          email: true,\r\n+          keyFob: true,\r\n+        },\r\n+        take: 15,\r\n+      });\r\n+    }\r\n+\r\n     res.json(members);\r\n   } catch (err) {\r\n     console.error('Search Error:', err);\r\n     res.status(500).json({ error: 'Failed to search members' });\r\n"
                },
                {
                    "date": 1752938969613,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -6,8 +6,67 @@\n \r\n const router = express.Router();\r\n const prisma = new PrismaClient();\r\n \r\n+\r\n+router.get('/search', async (req, res) => {\r\n+  const { q = '', clubId } = req.query;\r\n+\r\n+  if (!clubId) {\r\n+    return res.status(400).json({ error: 'Missing clubId' });\r\n+  }\r\n+\r\n+  try {\r\n+    let members;\r\n+\r\n+    if (q.length === 0) {\r\n+      // Return recent active members when no query provided\r\n+      members = await prisma.member.findMany({\r\n+        where: {\r\n+          clubId: String(clubId),\r\n+          memberType: 'member',\r\n+        },\r\n+        select: {\r\n+          id: true,\r\n+          firstName: true,\r\n+          lastName: true,\r\n+          email: true,\r\n+          keyFob: true,\r\n+        },\r\n+        orderBy: { createdAt: 'desc' },\r\n+        take: 10,\r\n+      });\r\n+    } else {\r\n+      // Perform filtered search\r\n+      members = await prisma.member.findMany({\r\n+        where: {\r\n+          clubId: String(clubId),\r\n+          OR: [\r\n+            { firstName: { contains: String(q), mode: 'insensitive' } },\r\n+            { lastName: { contains: String(q), mode: 'insensitive' } },\r\n+            { email: { contains: String(q), mode: 'insensitive' } },\r\n+            { keyFob: { contains: String(q), mode: 'insensitive' } },\r\n+          ],\r\n+        },\r\n+        select: {\r\n+          id: true,\r\n+          firstName: true,\r\n+          lastName: true,\r\n+          email: true,\r\n+          keyFob: true,\r\n+        },\r\n+        take: 15,\r\n+      });\r\n+    }\r\n+\r\n+    res.json(members);\r\n+  } catch (err) {\r\n+    console.error('Search Error:', err);\r\n+    res.status(500).json({ error: 'Failed to search members' });\r\n+  }\r\n+});\r\n+\r\n+\r\n router.get('/by-trainer', getMembersByTrainer); \r\n \r\n router.post('/', async (req, res) => {\r\n   try {\r\n@@ -429,66 +488,10 @@\n });\r\n \r\n \r\n // ðŸ” ADD THIS â€” handles search with ?q= and filters by clubId\r\n-router.get('/search', async (req, res) => {\r\n-  const { q = '', clubId } = req.query;\r\n \r\n-  if (!clubId) {\r\n-    return res.status(400).json({ error: 'Missing clubId' });\r\n-  }\r\n \r\n-  try {\r\n-    let members;\r\n \r\n-    if (q.length === 0) {\r\n-      // Return recent active members when no query provided\r\n-      members = await prisma.member.findMany({\r\n-        where: {\r\n-          clubId: String(clubId),\r\n-          memberType: 'member',\r\n-        },\r\n-        select: {\r\n-          id: true,\r\n-          firstName: true,\r\n-          lastName: true,\r\n-          email: true,\r\n-          keyFob: true,\r\n-        },\r\n-        orderBy: { createdAt: 'desc' },\r\n-        take: 10,\r\n-      });\r\n-    } else {\r\n-      // Perform filtered search\r\n-      members = await prisma.member.findMany({\r\n-        where: {\r\n-          clubId: String(clubId),\r\n-          OR: [\r\n-            { firstName: { contains: String(q), mode: 'insensitive' } },\r\n-            { lastName: { contains: String(q), mode: 'insensitive' } },\r\n-            { email: { contains: String(q), mode: 'insensitive' } },\r\n-            { keyFob: { contains: String(q), mode: 'insensitive' } },\r\n-          ],\r\n-        },\r\n-        select: {\r\n-          id: true,\r\n-          firstName: true,\r\n-          lastName: true,\r\n-          email: true,\r\n-          keyFob: true,\r\n-        },\r\n-        take: 15,\r\n-      });\r\n-    }\r\n \r\n-    res.json(members);\r\n-  } catch (err) {\r\n-    console.error('Search Error:', err);\r\n-    res.status(500).json({ error: 'Failed to search members' });\r\n-  }\r\n-});\r\n \r\n-\r\n-\r\n-\r\n-\r\n export default router;\r\n"
                },
                {
                    "date": 1753004870429,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -490,8 +490,34 @@\n \r\n // ðŸ” ADD THIS â€” handles search with ?q= and filters by clubId\r\n \r\n \r\n+router.get('/upcoming-renewals', async (req, res) => {\r\n+  const { clubId, days = 7 } = req.query;\r\n \r\n+  if (!clubId) return res.status(400).json({ error: 'Missing clubId' });\r\n \r\n+  const upcomingDate = new Date();\r\n+  upcomingDate.setDate(upcomingDate.getDate() + Number(days));\r\n \r\n+  try {\r\n+    const count = await prisma.membership.count({\r\n+      where: {\r\n+        member: { clubId: String(clubId) },\r\n+        endDate: {\r\n+          gte: new Date(),\r\n+          lte: upcomingDate,\r\n+        },\r\n+        status: 'active',\r\n+      },\r\n+    });\r\n+\r\n+    res.json({ count });\r\n+  } catch (error) {\r\n+    console.error('Error fetching upcoming renewals:', error);\r\n+    res.status(500).json({ error: 'Failed to fetch upcoming renewals' });\r\n+  }\r\n+});\r\n+\r\n+\r\n+\r\n export default router;\r\n"
                },
                {
                    "date": 1753006571244,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -369,8 +369,36 @@\n     res.status(500).json({ error: 'Failed to fetch members' });\r\n   }\r\n });\r\n \r\n+router.get('/upcoming-renewals', async (req, res) => {\r\n+  const { clubId, days = 7 } = req.query;\r\n+\r\n+  if (!clubId) return res.status(400).json({ error: 'Missing clubId' });\r\n+\r\n+  const upcomingDate = new Date();\r\n+  upcomingDate.setDate(upcomingDate.getDate() + Number(days));\r\n+\r\n+  try {\r\n+    const count = await prisma.membership.count({\r\n+      where: {\r\n+        member: { clubId: String(clubId) },\r\n+        endDate: {\r\n+          gte: new Date(),\r\n+          lte: upcomingDate,\r\n+        },\r\n+        status: 'active',\r\n+      },\r\n+    });\r\n+\r\n+    res.json({ count });\r\n+  } catch (error) {\r\n+    console.error('Error fetching upcoming renewals:', error);\r\n+    res.status(500).json({ error: 'Failed to fetch upcoming renewals' });\r\n+  }\r\n+});\r\n+\r\n+\r\n // GET /api/members/:id\r\n router.get('/:id', async (req, res) => {\r\n   const { id } = req.params;\r\n \r\n@@ -490,34 +518,8 @@\n \r\n // ðŸ” ADD THIS â€” handles search with ?q= and filters by clubId\r\n \r\n \r\n-router.get('/upcoming-renewals', async (req, res) => {\r\n-  const { clubId, days = 7 } = req.query;\r\n \r\n-  if (!clubId) return res.status(400).json({ error: 'Missing clubId' });\r\n \r\n-  const upcomingDate = new Date();\r\n-  upcomingDate.setDate(upcomingDate.getDate() + Number(days));\r\n \r\n-  try {\r\n-    const count = await prisma.membership.count({\r\n-      where: {\r\n-        member: { clubId: String(clubId) },\r\n-        endDate: {\r\n-          gte: new Date(),\r\n-          lte: upcomingDate,\r\n-        },\r\n-        status: 'active',\r\n-      },\r\n-    });\r\n-\r\n-    res.json({ count });\r\n-  } catch (error) {\r\n-    console.error('Error fetching upcoming renewals:', error);\r\n-    res.status(500).json({ error: 'Failed to fetch upcoming renewals' });\r\n-  }\r\n-});\r\n-\r\n-\r\n-\r\n export default router;\r\n"
                },
                {
                    "date": 1753036392295,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -515,11 +515,24 @@\n   }\r\n });\r\n \r\n \r\n-// ðŸ” ADD THIS â€” handles search with ?q= and filters by clubId\r\n \r\n \r\n+router.get('/count', async (req, res) => {\r\n+  try {\r\n+    const count = await prisma.member.count({\r\n+      where: { memberType: 'member' },\r\n+    });\r\n+    res.json({ count });\r\n+  } catch (err) {\r\n+    console.error('Error fetching member count:', err);\r\n+    res.status(500).json({ error: 'Failed to fetch member count' });\r\n+  }\r\n+});\r\n \r\n \r\n \r\n+\r\n+\r\n+\r\n export default router;\r\n"
                },
                {
                    "date": 1753036553068,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -0,0 +1,538 @@\n+//src>routes>member.routes.ts\r\n+import express from 'express';\r\n+import { PrismaClient } from '@prisma/client';\r\n+import { Request, Response } from 'express';\r\n+import { getMembersByTrainer } from '../controllers/member.controller';\r\n+\r\n+const router = express.Router();\r\n+const prisma = new PrismaClient();\r\n+\r\n+\r\n+router.get('/search', async (req, res) => {\r\n+  const { q = '', clubId } = req.query;\r\n+\r\n+  if (!clubId) {\r\n+    return res.status(400).json({ error: 'Missing clubId' });\r\n+  }\r\n+\r\n+  try {\r\n+    let members;\r\n+\r\n+    if (q.length === 0) {\r\n+      // Return recent active members when no query provided\r\n+      members = await prisma.member.findMany({\r\n+        where: {\r\n+          clubId: String(clubId),\r\n+          memberType: 'member',\r\n+        },\r\n+        select: {\r\n+          id: true,\r\n+          firstName: true,\r\n+          lastName: true,\r\n+          email: true,\r\n+          keyFob: true,\r\n+        },\r\n+        orderBy: { createdAt: 'desc' },\r\n+        take: 10,\r\n+      });\r\n+    } else {\r\n+      // Perform filtered search\r\n+      members = await prisma.member.findMany({\r\n+        where: {\r\n+          clubId: String(clubId),\r\n+          OR: [\r\n+            { firstName: { contains: String(q), mode: 'insensitive' } },\r\n+            { lastName: { contains: String(q), mode: 'insensitive' } },\r\n+            { email: { contains: String(q), mode: 'insensitive' } },\r\n+            { keyFob: { contains: String(q), mode: 'insensitive' } },\r\n+          ],\r\n+        },\r\n+        select: {\r\n+          id: true,\r\n+          firstName: true,\r\n+          lastName: true,\r\n+          email: true,\r\n+          keyFob: true,\r\n+        },\r\n+        take: 15,\r\n+      });\r\n+    }\r\n+\r\n+    res.json(members);\r\n+  } catch (err) {\r\n+    console.error('Search Error:', err);\r\n+    res.status(500).json({ error: 'Failed to search members' });\r\n+  }\r\n+});\r\n+\r\n+\r\n+router.get('/by-trainer', getMembersByTrainer); \r\n+\r\n+router.post('/', async (req, res) => {\r\n+  try {\r\n+    const {\r\n+      firstName, lastName, email, phone, work, dateOfBirth, gender, avatar,\r\n+      club, keyFob, tags, note, memberType,\r\n+      address, marketing, additional, emergency,\r\n+      medicalInfo,\r\n+    } = req.body;\r\n+\r\n+    const newMember = await prisma.member.create({\r\n+      data: {\r\n+        firstName,\r\n+        lastName,\r\n+        email,\r\n+        phone,\r\n+        work,\r\n+        dateOfBirth: dateOfBirth ? new Date(dateOfBirth) : null,\r\n+        gender,\r\n+        avatarUrl: avatar || null,\r\n+        keyFob,\r\n+        tags,\r\n+        note,\r\n+        memberType,\r\n+\r\n+        // Address\r\n+        street: address?.street || null,\r\n+        city: address?.city || null,\r\n+        state: address?.state || null,\r\n+        zip: address?.zip || null,\r\n+        addressSearch: address?.search || null,\r\n+\r\n+        // Marketing\r\n+        salesRep: marketing?.salesRep || null,\r\n+        sourcePromotion: marketing?.sourcePromotion || null,\r\n+        referredBy: marketing?.referredBy || null,\r\n+\r\n+        // Additional\r\n+        trainerId: additional?.trainerId || null,\r\n+        joiningDate: additional?.joiningDate ? new Date(additional.joiningDate) : null,\r\n+        occupation: additional?.occupation || null,\r\n+        organization: additional?.organization || null,\r\n+        involvementType: additional?.involvementType || null,\r\n+\r\n+        // Emergency\r\n+    \r\n+\r\n+        emergency: emergency || [],\r\n+\r\n+        medicalInfo,\r\n+        clubId: club,\r\n+      },\r\n+    });\r\n+\r\n+    res.status(201).json(newMember);\r\n+  } catch (err) {\r\n+    console.error('Add Member Error:', err);\r\n+    res.status(500).json({ error: 'Failed to create member' });\r\n+  }\r\n+});\r\n+\r\n+\r\n+\r\n+// router.post('/:id/membership', async (req, res) => {\r\n+//   try {\r\n+//     const { id } = req.params;\r\n+//     const { planName, startDate, endDate, autoRenew, status } = req.body;\r\n+\r\n+//     const plan = await prisma.membershipPlan.findUnique({\r\n+//   where: { name: planName },\r\n+// });\r\n+// if (!plan) {\r\n+//   return res.status(400).json({ error: 'Invalid plan selected' });\r\n+// }\r\n+\r\n+\r\n+//     const active = await prisma.membership.findFirst({\r\n+//   where: { memberId: id, status: 'active' }\r\n+\r\n+// });\r\n+\r\n+// if (active) {\r\n+//   return res.status(400).json({\r\n+//     error: 'This member already has an active membership. Please cancel or expire it first.'\r\n+//   });\r\n+// }\r\n+\r\n+//     const membership = await prisma.membership.create({\r\n+//       data: {\r\n+//         planName,\r\n+//         startDate: new Date(startDate),\r\n+//         endDate: new Date(endDate),\r\n+//         autoRenew,\r\n+//         status,\r\n+//         memberId: id,\r\n+//       },\r\n+//     });\r\n+\r\n+//     const member = await prisma.member.findUnique({\r\n+//       where: { id },\r\n+//       select: { clubId: true },\r\n+//     });\r\n+\r\n+//     if (!member) {\r\n+//       return res.status(404).json({ error: 'Member not found' });\r\n+//     }\r\n+\r\n+//     await prisma.invoice.create({\r\n+//   data: {\r\n+//     memberId: id,\r\n+//     planName,\r\n+//     amount: plan.price,\r\n+//     status: 'unpaid',\r\n+//     clubId: member.clubId,\r\n+//     issuedAt: new Date(),\r\n+//     dueDate: new Date(new Date().setDate(new Date().getDate() + 7)),\r\n+//   },\r\n+// });\r\n+\r\n+//     res.status(201).json(membership);\r\n+//   } catch (err) {\r\n+//     console.error('Add Membership Error:', err);\r\n+//     res.status(500).json({ error: 'Failed to create membership' });\r\n+//   }\r\n+// });\r\n+// In your member.routes.ts, update the membership creation route:\r\n+\r\n+router.post('/:id/membership', async (req, res) => {\r\n+  try {\r\n+    const { id } = req.params;\r\n+    const { planName, startDate, endDate, autoRenew, status } = req.body;\r\n+\r\n+    console.log('Creating membership for member:', id);\r\n+    console.log('Request body:', req.body);\r\n+\r\n+    const plan = await prisma.membershipPlan.findUnique({\r\n+      where: { name: planName },\r\n+    });\r\n+    \r\n+    if (!plan) {\r\n+      return res.status(400).json({ error: 'Invalid plan selected' });\r\n+    }\r\n+\r\n+    const active = await prisma.membership.findFirst({\r\n+      where: { memberId: id, status: 'active' }\r\n+    });\r\n+\r\n+    if (active) {\r\n+      return res.status(400).json({\r\n+        error: 'This member already has an active membership. Please cancel or expire it first.'\r\n+      });\r\n+    }\r\n+\r\n+    const membership = await prisma.membership.create({\r\n+      data: {\r\n+        planName,\r\n+        startDate: new Date(startDate),\r\n+        endDate: new Date(endDate),\r\n+        autoRenew,\r\n+        status,\r\n+        memberId: id,\r\n+      },\r\n+    });\r\n+\r\n+    console.log('Membership created:', membership);\r\n+\r\n+    // Get member details\r\n+    const member = await prisma.member.findUnique({\r\n+      where: { id },\r\n+      select: { clubId: true, firstName: true, lastName: true },\r\n+    });\r\n+\r\n+    console.log('Member found:', member);\r\n+\r\n+    if (!member) {\r\n+      return res.status(404).json({ error: 'Member not found' });\r\n+    }\r\n+\r\n+    if (!member.clubId) {\r\n+      return res.status(400).json({ error: 'Member does not have a clubId assigned' });\r\n+    }\r\n+\r\n+    // Create invoice with detailed logging\r\n+    console.log('Creating invoice with data:', {\r\n+      memberId: id,\r\n+      planName,\r\n+      amount: plan.price,\r\n+      status: 'unpaid',\r\n+      clubId: member.clubId,\r\n+      issuedAt: new Date(),\r\n+      dueDate: new Date(new Date().setDate(new Date().getDate() + 7)),\r\n+    });\r\n+\r\n+    try {\r\n+      const invoice = await prisma.invoice.create({\r\n+        data: {\r\n+          memberId: id,\r\n+          planName,\r\n+          amount: plan.price,\r\n+          status: 'unpaid',\r\n+          clubId: member.clubId,\r\n+          issuedAt: new Date(),\r\n+          dueDate: new Date(new Date().setDate(new Date().getDate() + 7)),\r\n+        },\r\n+      });\r\n+\r\n+      console.log('Invoice created successfully:', invoice);\r\n+      \r\n+      res.status(201).json({\r\n+        membership,\r\n+        invoice,\r\n+        message: 'Membership and invoice created successfully'\r\n+      });\r\n+      \r\n+    } catch (invoiceError) {\r\n+      console.error('Invoice creation error:', invoiceError);\r\n+      \r\n+      // If invoice creation fails, we might want to rollback the membership\r\n+      await prisma.membership.delete({\r\n+        where: { id: membership.id }\r\n+      });\r\n+      \r\n+      return res.status(500).json({ \r\n+        error: 'Failed to create invoice', \r\n+        details: invoiceError.message \r\n+      });\r\n+    }\r\n+\r\n+  } catch (err) {\r\n+    console.error('Add Membership Error:', err);\r\n+    res.status(500).json({ \r\n+      error: 'Failed to create membership',\r\n+      details: err.message \r\n+    });\r\n+  }\r\n+});\r\n+\r\n+\r\n+router.get('/', async (req, res) => {\r\n+  try {\r\n+    const { tab = 'all', search = '', page = 1, limit = 10, clubId, trainerId } = req.query;\r\n+    const skip = (Number(page) - 1) * Number(limit);\r\n+\r\n+    let whereClause: any = {\r\n+      clubId: String(clubId),\r\n+    };\r\n+\r\n+    if (trainerId) {\r\n+    whereClause.trainerId = trainerId; // âœ… FILTER BY TRAINER\r\n+  }\r\n+\r\n+    if (search) {\r\n+      whereClause.OR = [\r\n+        { firstName: { contains: search, mode: 'insensitive' } },\r\n+        { lastName: { contains: search, mode: 'insensitive' } },\r\n+        { email: { contains: search, mode: 'insensitive' } },\r\n+      ];\r\n+    }\r\n+\r\n+    switch (tab) {\r\n+      case 'active':\r\n+        whereClause.memberType = 'member';\r\n+        break;\r\n+      case 'expired':\r\n+        whereClause.memberType = 'member';\r\n+        whereClause.keyFob = null;\r\n+        break;\r\n+      case 'prospect':\r\n+        whereClause.memberType = 'prospect';\r\n+        break;\r\n+      case 'recent':\r\n+        const thirtyDaysAgo = new Date();\r\n+        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);\r\n+        whereClause.createdAt = { gte: thirtyDaysAgo };\r\n+        break;\r\n+      default:\r\n+        break;\r\n+    }\r\n+\r\n+    const [members, total] = await Promise.all([\r\n+      prisma.member.findMany({\r\n+        where: whereClause,\r\n+        orderBy: { createdAt: 'desc' },\r\n+        skip,\r\n+        take: Number(limit),\r\n+      }),\r\n+      prisma.member.count({ where: whereClause }),\r\n+    ]);\r\n+\r\n+    res.json({\r\n+      data: members,\r\n+      meta: {\r\n+        total,\r\n+        page: Number(page),\r\n+        pageSize: Number(limit),\r\n+      },\r\n+    });\r\n+  } catch (err) {\r\n+    console.error(err);\r\n+    res.status(500).json({ error: 'Failed to fetch members' });\r\n+  }\r\n+});\r\n+\r\n+router.get('/upcoming-renewals', async (req, res) => {\r\n+  const { clubId, days = 7 } = req.query;\r\n+\r\n+  if (!clubId) return res.status(400).json({ error: 'Missing clubId' });\r\n+\r\n+  const upcomingDate = new Date();\r\n+  upcomingDate.setDate(upcomingDate.getDate() + Number(days));\r\n+\r\n+  try {\r\n+    const count = await prisma.membership.count({\r\n+      where: {\r\n+        member: { clubId: String(clubId) },\r\n+        endDate: {\r\n+          gte: new Date(),\r\n+          lte: upcomingDate,\r\n+        },\r\n+        status: 'active',\r\n+      },\r\n+    });\r\n+\r\n+    res.json({ count });\r\n+  } catch (error) {\r\n+    console.error('Error fetching upcoming renewals:', error);\r\n+    res.status(500).json({ error: 'Failed to fetch upcoming renewals' });\r\n+  }\r\n+});\r\n+\r\n+\r\n+// GET /api/members/:id\r\n+router.get('/:id', async (req, res) => {\r\n+  const { id } = req.params;\r\n+\r\n+  try {\r\n+    const member = await prisma.member.findUnique({\r\n+      where: { id },\r\n+      include: {\r\n+        trainer: true,\r\n+        club: true,\r\n+        membership: {\r\n+      orderBy: { startDate: 'desc' }, // Get most recent first\r\n+      take: 1,                        // Optional: only return one latest\r\n+    },\r\n+      },\r\n+    });\r\n+\r\n+      console.log('ðŸ‘¨â€âš•ï¸ Full member details:', member); // âœ… ADD THIS\r\n+\r\n+    if (!member) return res.status(404).json({ error: 'Member not found' });\r\n+\r\n+    res.json(member);\r\n+  } catch (err) {\r\n+    console.error('Fetch member detail error:', err);\r\n+    res.status(500).json({ error: 'Failed to fetch member details' });\r\n+  }\r\n+});\r\n+\r\n+//update member\r\n+\r\n+// PUT /api/members/:id\r\n+router.put('/:id', async (req: Request, res: Response) => {\r\n+  try {\r\n+    const { id } = req.params;\r\n+    const updatedData = req.body;\r\n+\r\n+    const updated = await prisma.member.update({\r\n+      where: { id },\r\n+      data: {\r\n+        firstName: updatedData.firstName,\r\n+        lastName: updatedData.lastName,\r\n+        email: updatedData.email,\r\n+        phone: updatedData.phone,\r\n+        work: updatedData.work,\r\n+        dateOfBirth: updatedData.dateOfBirth ? new Date(updatedData.dateOfBirth) : null,\r\n+        gender: updatedData.gender,\r\n+        avatarUrl: updatedData.avatar || null,\r\n+        keyFob: updatedData.keyFob,\r\n+        tags: updatedData.tags,\r\n+        note: updatedData.note,\r\n+        memberType: updatedData.memberType,\r\n+\r\n+        // Address\r\n+        street: updatedData.address?.street || null,\r\n+        city: updatedData.address?.city || null,\r\n+        state: updatedData.address?.state || null,\r\n+        zip: updatedData.address?.zip || null,\r\n+        addressSearch: updatedData.address?.search || null,\r\n+\r\n+        // Marketing\r\n+        salesRep: updatedData.marketing?.salesRep || null,\r\n+        sourcePromotion: updatedData.marketing?.sourcePromotion || null,\r\n+        referredBy: updatedData.marketing?.referredBy || null,\r\n+\r\n+        // Additional\r\n+        trainerId: updatedData.additional?.trainerId || null,\r\n+        joiningDate: updatedData.additional?.joiningDate ? new Date(updatedData.additional.joiningDate) : null,\r\n+        occupation: updatedData.additional?.occupation || null,\r\n+        organization: updatedData.additional?.organization || null,\r\n+        involvementType: updatedData.additional?.involvementType || null,\r\n+\r\n+        // Emergency\r\n+        emergency: updatedData.emergency || [],\r\n+//medical information\r\n+        medicalInfo: updatedData.medicalInfo || '',\r\n+allergies: updatedData.allergies || '',\r\n+medications: updatedData.medications || '',\r\n+chronicConditions: updatedData.chronicConditions || '',\r\n+injuries: updatedData.injuries || '',\r\n+doctorContact: updatedData.doctorContact || '',\r\n+lastExamDate: updatedData.lastExamDate ? new Date(updatedData.lastExamDate) : null,\r\n+        clubId: updatedData.club,\r\n+      },\r\n+    });\r\n+\r\n+    return res.status(200).json(updated);\r\n+  } catch (err) {\r\n+    console.error('Error updating member:', err);\r\n+    return res.status(500).json({ error: 'Failed to update member' });\r\n+  }\r\n+});\r\n+\r\n+// GET /api/members/:id/sessions - All attendance sessions for a member\r\n+router.get('/:id/sessions', async (req, res) => {\r\n+  const { id } = req.params;\r\n+\r\n+  try {\r\n+    const attendanceRecords = await prisma.attendance.findMany({\r\n+      where: { memberId: id },\r\n+      orderBy: { markedAt: 'desc' },\r\n+      include: {\r\n+        schedule: {\r\n+          include: {\r\n+            trainer: { select: { name: true } },\r\n+            location: { select: { name: true } }\r\n+          }\r\n+        }\r\n+      }\r\n+    });\r\n+\r\n+    res.json(attendanceRecords);\r\n+  } catch (err) {\r\n+    console.error('Error fetching session history:', err);\r\n+    res.status(500).json({ error: 'Failed to fetch session history' });\r\n+  }\r\n+});\r\n+\r\n+\r\n+\r\n+\r\n+router.get('/count', async (req, res) => {\r\n+  try {\r\n+    const count = await prisma.member.count({\r\n+      where: { memberType: 'member' },\r\n+    });\r\n+    res.json({ count });\r\n+  } catch (err) {\r\n+    console.error('Error fetching member count:', err);\r\n+    res.status(500).json({ error: 'Failed to fetch member count' });\r\n+  }\r\n+});\r\n+\r\n+\r\n+\r\n+\r\n+\r\n+\r\n+export default router;\r\n"
                },
                {
                    "date": 1753036553161,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -535,542 +535,4 @@\n \r\n \r\n \r\n export default router;\r\n-//src>routes>member.routes.ts\r\n-import express from 'express';\r\n-import { PrismaClient } from '@prisma/client';\r\n-import { Request, Response } from 'express';\r\n-import { getMembersByTrainer } from '../controllers/member.controller';\r\n-\r\n-const router = express.Router();\r\n-const prisma = new PrismaClient();\r\n-\r\n-\r\n-router.get('/search', async (req, res) => {\r\n-  const { q = '', clubId } = req.query;\r\n-\r\n-  if (!clubId) {\r\n-    return res.status(400).json({ error: 'Missing clubId' });\r\n-  }\r\n-\r\n-  try {\r\n-    let members;\r\n-\r\n-    if (q.length === 0) {\r\n-      // Return recent active members when no query provided\r\n-      members = await prisma.member.findMany({\r\n-        where: {\r\n-          clubId: String(clubId),\r\n-          memberType: 'member',\r\n-        },\r\n-        select: {\r\n-          id: true,\r\n-          firstName: true,\r\n-          lastName: true,\r\n-          email: true,\r\n-          keyFob: true,\r\n-        },\r\n-        orderBy: { createdAt: 'desc' },\r\n-        take: 10,\r\n-      });\r\n-    } else {\r\n-      // Perform filtered search\r\n-      members = await prisma.member.findMany({\r\n-        where: {\r\n-          clubId: String(clubId),\r\n-          OR: [\r\n-            { firstName: { contains: String(q), mode: 'insensitive' } },\r\n-            { lastName: { contains: String(q), mode: 'insensitive' } },\r\n-            { email: { contains: String(q), mode: 'insensitive' } },\r\n-            { keyFob: { contains: String(q), mode: 'insensitive' } },\r\n-          ],\r\n-        },\r\n-        select: {\r\n-          id: true,\r\n-          firstName: true,\r\n-          lastName: true,\r\n-          email: true,\r\n-          keyFob: true,\r\n-        },\r\n-        take: 15,\r\n-      });\r\n-    }\r\n-\r\n-    res.json(members);\r\n-  } catch (err) {\r\n-    console.error('Search Error:', err);\r\n-    res.status(500).json({ error: 'Failed to search members' });\r\n-  }\r\n-});\r\n-\r\n-\r\n-router.get('/by-trainer', getMembersByTrainer); \r\n-\r\n-router.post('/', async (req, res) => {\r\n-  try {\r\n-    const {\r\n-      firstName, lastName, email, phone, work, dateOfBirth, gender, avatar,\r\n-      club, keyFob, tags, note, memberType,\r\n-      address, marketing, additional, emergency,\r\n-      medicalInfo,\r\n-    } = req.body;\r\n-\r\n-    const newMember = await prisma.member.create({\r\n-      data: {\r\n-        firstName,\r\n-        lastName,\r\n-        email,\r\n-        phone,\r\n-        work,\r\n-        dateOfBirth: dateOfBirth ? new Date(dateOfBirth) : null,\r\n-        gender,\r\n-        avatarUrl: avatar || null,\r\n-        keyFob,\r\n-        tags,\r\n-        note,\r\n-        memberType,\r\n-\r\n-        // Address\r\n-        street: address?.street || null,\r\n-        city: address?.city || null,\r\n-        state: address?.state || null,\r\n-        zip: address?.zip || null,\r\n-        addressSearch: address?.search || null,\r\n-\r\n-        // Marketing\r\n-        salesRep: marketing?.salesRep || null,\r\n-        sourcePromotion: marketing?.sourcePromotion || null,\r\n-        referredBy: marketing?.referredBy || null,\r\n-\r\n-        // Additional\r\n-        trainerId: additional?.trainerId || null,\r\n-        joiningDate: additional?.joiningDate ? new Date(additional.joiningDate) : null,\r\n-        occupation: additional?.occupation || null,\r\n-        organization: additional?.organization || null,\r\n-        involvementType: additional?.involvementType || null,\r\n-\r\n-        // Emergency\r\n-    \r\n-\r\n-        emergency: emergency || [],\r\n-\r\n-        medicalInfo,\r\n-        clubId: club,\r\n-      },\r\n-    });\r\n-\r\n-    res.status(201).json(newMember);\r\n-  } catch (err) {\r\n-    console.error('Add Member Error:', err);\r\n-    res.status(500).json({ error: 'Failed to create member' });\r\n-  }\r\n-});\r\n-\r\n-\r\n-\r\n-// router.post('/:id/membership', async (req, res) => {\r\n-//   try {\r\n-//     const { id } = req.params;\r\n-//     const { planName, startDate, endDate, autoRenew, status } = req.body;\r\n-\r\n-//     const plan = await prisma.membershipPlan.findUnique({\r\n-//   where: { name: planName },\r\n-// });\r\n-// if (!plan) {\r\n-//   return res.status(400).json({ error: 'Invalid plan selected' });\r\n-// }\r\n-\r\n-\r\n-//     const active = await prisma.membership.findFirst({\r\n-//   where: { memberId: id, status: 'active' }\r\n-\r\n-// });\r\n-\r\n-// if (active) {\r\n-//   return res.status(400).json({\r\n-//     error: 'This member already has an active membership. Please cancel or expire it first.'\r\n-//   });\r\n-// }\r\n-\r\n-//     const membership = await prisma.membership.create({\r\n-//       data: {\r\n-//         planName,\r\n-//         startDate: new Date(startDate),\r\n-//         endDate: new Date(endDate),\r\n-//         autoRenew,\r\n-//         status,\r\n-//         memberId: id,\r\n-//       },\r\n-//     });\r\n-\r\n-//     const member = await prisma.member.findUnique({\r\n-//       where: { id },\r\n-//       select: { clubId: true },\r\n-//     });\r\n-\r\n-//     if (!member) {\r\n-//       return res.status(404).json({ error: 'Member not found' });\r\n-//     }\r\n-\r\n-//     await prisma.invoice.create({\r\n-//   data: {\r\n-//     memberId: id,\r\n-//     planName,\r\n-//     amount: plan.price,\r\n-//     status: 'unpaid',\r\n-//     clubId: member.clubId,\r\n-//     issuedAt: new Date(),\r\n-//     dueDate: new Date(new Date().setDate(new Date().getDate() + 7)),\r\n-//   },\r\n-// });\r\n-\r\n-//     res.status(201).json(membership);\r\n-//   } catch (err) {\r\n-//     console.error('Add Membership Error:', err);\r\n-//     res.status(500).json({ error: 'Failed to create membership' });\r\n-//   }\r\n-// });\r\n-// In your member.routes.ts, update the membership creation route:\r\n-\r\n-router.post('/:id/membership', async (req, res) => {\r\n-  try {\r\n-    const { id } = req.params;\r\n-    const { planName, startDate, endDate, autoRenew, status } = req.body;\r\n-\r\n-    console.log('Creating membership for member:', id);\r\n-    console.log('Request body:', req.body);\r\n-\r\n-    const plan = await prisma.membershipPlan.findUnique({\r\n-      where: { name: planName },\r\n-    });\r\n-    \r\n-    if (!plan) {\r\n-      return res.status(400).json({ error: 'Invalid plan selected' });\r\n-    }\r\n-\r\n-    const active = await prisma.membership.findFirst({\r\n-      where: { memberId: id, status: 'active' }\r\n-    });\r\n-\r\n-    if (active) {\r\n-      return res.status(400).json({\r\n-        error: 'This member already has an active membership. Please cancel or expire it first.'\r\n-      });\r\n-    }\r\n-\r\n-    const membership = await prisma.membership.create({\r\n-      data: {\r\n-        planName,\r\n-        startDate: new Date(startDate),\r\n-        endDate: new Date(endDate),\r\n-        autoRenew,\r\n-        status,\r\n-        memberId: id,\r\n-      },\r\n-    });\r\n-\r\n-    console.log('Membership created:', membership);\r\n-\r\n-    // Get member details\r\n-    const member = await prisma.member.findUnique({\r\n-      where: { id },\r\n-      select: { clubId: true, firstName: true, lastName: true },\r\n-    });\r\n-\r\n-    console.log('Member found:', member);\r\n-\r\n-    if (!member) {\r\n-      return res.status(404).json({ error: 'Member not found' });\r\n-    }\r\n-\r\n-    if (!member.clubId) {\r\n-      return res.status(400).json({ error: 'Member does not have a clubId assigned' });\r\n-    }\r\n-\r\n-    // Create invoice with detailed logging\r\n-    console.log('Creating invoice with data:', {\r\n-      memberId: id,\r\n-      planName,\r\n-      amount: plan.price,\r\n-      status: 'unpaid',\r\n-      clubId: member.clubId,\r\n-      issuedAt: new Date(),\r\n-      dueDate: new Date(new Date().setDate(new Date().getDate() + 7)),\r\n-    });\r\n-\r\n-    try {\r\n-      const invoice = await prisma.invoice.create({\r\n-        data: {\r\n-          memberId: id,\r\n-          planName,\r\n-          amount: plan.price,\r\n-          status: 'unpaid',\r\n-          clubId: member.clubId,\r\n-          issuedAt: new Date(),\r\n-          dueDate: new Date(new Date().setDate(new Date().getDate() + 7)),\r\n-        },\r\n-      });\r\n-\r\n-      console.log('Invoice created successfully:', invoice);\r\n-      \r\n-      res.status(201).json({\r\n-        membership,\r\n-        invoice,\r\n-        message: 'Membership and invoice created successfully'\r\n-      });\r\n-      \r\n-    } catch (invoiceError) {\r\n-      console.error('Invoice creation error:', invoiceError);\r\n-      \r\n-      // If invoice creation fails, we might want to rollback the membership\r\n-      await prisma.membership.delete({\r\n-        where: { id: membership.id }\r\n-      });\r\n-      \r\n-      return res.status(500).json({ \r\n-        error: 'Failed to create invoice', \r\n-        details: invoiceError.message \r\n-      });\r\n-    }\r\n-\r\n-  } catch (err) {\r\n-    console.error('Add Membership Error:', err);\r\n-    res.status(500).json({ \r\n-      error: 'Failed to create membership',\r\n-      details: err.message \r\n-    });\r\n-  }\r\n-});\r\n-\r\n-\r\n-router.get('/', async (req, res) => {\r\n-  try {\r\n-    const { tab = 'all', search = '', page = 1, limit = 10, clubId, trainerId } = req.query;\r\n-    const skip = (Number(page) - 1) * Number(limit);\r\n-\r\n-    let whereClause: any = {\r\n-      clubId: String(clubId),\r\n-    };\r\n-\r\n-    if (trainerId) {\r\n-    whereClause.trainerId = trainerId; // âœ… FILTER BY TRAINER\r\n-  }\r\n-\r\n-    if (search) {\r\n-      whereClause.OR = [\r\n-        { firstName: { contains: search, mode: 'insensitive' } },\r\n-        { lastName: { contains: search, mode: 'insensitive' } },\r\n-        { email: { contains: search, mode: 'insensitive' } },\r\n-      ];\r\n-    }\r\n-\r\n-    switch (tab) {\r\n-      case 'active':\r\n-        whereClause.memberType = 'member';\r\n-        break;\r\n-      case 'expired':\r\n-        whereClause.memberType = 'member';\r\n-        whereClause.keyFob = null;\r\n-        break;\r\n-      case 'prospect':\r\n-        whereClause.memberType = 'prospect';\r\n-        break;\r\n-      case 'recent':\r\n-        const thirtyDaysAgo = new Date();\r\n-        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);\r\n-        whereClause.createdAt = { gte: thirtyDaysAgo };\r\n-        break;\r\n-      default:\r\n-        break;\r\n-    }\r\n-\r\n-    const [members, total] = await Promise.all([\r\n-      prisma.member.findMany({\r\n-        where: whereClause,\r\n-        orderBy: { createdAt: 'desc' },\r\n-        skip,\r\n-        take: Number(limit),\r\n-      }),\r\n-      prisma.member.count({ where: whereClause }),\r\n-    ]);\r\n-\r\n-    res.json({\r\n-      data: members,\r\n-      meta: {\r\n-        total,\r\n-        page: Number(page),\r\n-        pageSize: Number(limit),\r\n-      },\r\n-    });\r\n-  } catch (err) {\r\n-    console.error(err);\r\n-    res.status(500).json({ error: 'Failed to fetch members' });\r\n-  }\r\n-});\r\n-\r\n-router.get('/upcoming-renewals', async (req, res) => {\r\n-  const { clubId, days = 7 } = req.query;\r\n-\r\n-  if (!clubId) return res.status(400).json({ error: 'Missing clubId' });\r\n-\r\n-  const upcomingDate = new Date();\r\n-  upcomingDate.setDate(upcomingDate.getDate() + Number(days));\r\n-\r\n-  try {\r\n-    const count = await prisma.membership.count({\r\n-      where: {\r\n-        member: { clubId: String(clubId) },\r\n-        endDate: {\r\n-          gte: new Date(),\r\n-          lte: upcomingDate,\r\n-        },\r\n-        status: 'active',\r\n-      },\r\n-    });\r\n-\r\n-    res.json({ count });\r\n-  } catch (error) {\r\n-    console.error('Error fetching upcoming renewals:', error);\r\n-    res.status(500).json({ error: 'Failed to fetch upcoming renewals' });\r\n-  }\r\n-});\r\n-\r\n-\r\n-// GET /api/members/:id\r\n-router.get('/:id', async (req, res) => {\r\n-  const { id } = req.params;\r\n-\r\n-  try {\r\n-    const member = await prisma.member.findUnique({\r\n-      where: { id },\r\n-      include: {\r\n-        trainer: true,\r\n-        club: true,\r\n-        membership: {\r\n-      orderBy: { startDate: 'desc' }, // Get most recent first\r\n-      take: 1,                        // Optional: only return one latest\r\n-    },\r\n-      },\r\n-    });\r\n-\r\n-      console.log('ðŸ‘¨â€âš•ï¸ Full member details:', member); // âœ… ADD THIS\r\n-\r\n-    if (!member) return res.status(404).json({ error: 'Member not found' });\r\n-\r\n-    res.json(member);\r\n-  } catch (err) {\r\n-    console.error('Fetch member detail error:', err);\r\n-    res.status(500).json({ error: 'Failed to fetch member details' });\r\n-  }\r\n-});\r\n-\r\n-//update member\r\n-\r\n-// PUT /api/members/:id\r\n-router.put('/:id', async (req: Request, res: Response) => {\r\n-  try {\r\n-    const { id } = req.params;\r\n-    const updatedData = req.body;\r\n-\r\n-    const updated = await prisma.member.update({\r\n-      where: { id },\r\n-      data: {\r\n-        firstName: updatedData.firstName,\r\n-        lastName: updatedData.lastName,\r\n-        email: updatedData.email,\r\n-        phone: updatedData.phone,\r\n-        work: updatedData.work,\r\n-        dateOfBirth: updatedData.dateOfBirth ? new Date(updatedData.dateOfBirth) : null,\r\n-        gender: updatedData.gender,\r\n-        avatarUrl: updatedData.avatar || null,\r\n-        keyFob: updatedData.keyFob,\r\n-        tags: updatedData.tags,\r\n-        note: updatedData.note,\r\n-        memberType: updatedData.memberType,\r\n-\r\n-        // Address\r\n-        street: updatedData.address?.street || null,\r\n-        city: updatedData.address?.city || null,\r\n-        state: updatedData.address?.state || null,\r\n-        zip: updatedData.address?.zip || null,\r\n-        addressSearch: updatedData.address?.search || null,\r\n-\r\n-        // Marketing\r\n-        salesRep: updatedData.marketing?.salesRep || null,\r\n-        sourcePromotion: updatedData.marketing?.sourcePromotion || null,\r\n-        referredBy: updatedData.marketing?.referredBy || null,\r\n-\r\n-        // Additional\r\n-        trainerId: updatedData.additional?.trainerId || null,\r\n-        joiningDate: updatedData.additional?.joiningDate ? new Date(updatedData.additional.joiningDate) : null,\r\n-        occupation: updatedData.additional?.occupation || null,\r\n-        organization: updatedData.additional?.organization || null,\r\n-        involvementType: updatedData.additional?.involvementType || null,\r\n-\r\n-        // Emergency\r\n-        emergency: updatedData.emergency || [],\r\n-//medical information\r\n-        medicalInfo: updatedData.medicalInfo || '',\r\n-allergies: updatedData.allergies || '',\r\n-medications: updatedData.medications || '',\r\n-chronicConditions: updatedData.chronicConditions || '',\r\n-injuries: updatedData.injuries || '',\r\n-doctorContact: updatedData.doctorContact || '',\r\n-lastExamDate: updatedData.lastExamDate ? new Date(updatedData.lastExamDate) : null,\r\n-        clubId: updatedData.club,\r\n-      },\r\n-    });\r\n-\r\n-    return res.status(200).json(updated);\r\n-  } catch (err) {\r\n-    console.error('Error updating member:', err);\r\n-    return res.status(500).json({ error: 'Failed to update member' });\r\n-  }\r\n-});\r\n-\r\n-// GET /api/members/:id/sessions - All attendance sessions for a member\r\n-router.get('/:id/sessions', async (req, res) => {\r\n-  const { id } = req.params;\r\n-\r\n-  try {\r\n-    const attendanceRecords = await prisma.attendance.findMany({\r\n-      where: { memberId: id },\r\n-      orderBy: { markedAt: 'desc' },\r\n-      include: {\r\n-        schedule: {\r\n-          include: {\r\n-            trainer: { select: { name: true } },\r\n-            location: { select: { name: true } }\r\n-          }\r\n-        }\r\n-      }\r\n-    });\r\n-\r\n-    res.json(attendanceRecords);\r\n-  } catch (err) {\r\n-    console.error('Error fetching session history:', err);\r\n-    res.status(500).json({ error: 'Failed to fetch session history' });\r\n-  }\r\n-});\r\n-\r\n-\r\n-\r\n-\r\n-router.get('/count', async (req, res) => {\r\n-  try {\r\n-    const count = await prisma.member.count({\r\n-      where: { memberType: 'member' },\r\n-    });\r\n-    res.json({ count });\r\n-  } catch (err) {\r\n-    console.error('Error fetching member count:', err);\r\n-    res.status(500).json({ error: 'Failed to fetch member count' });\r\n-  }\r\n-});\r\n-\r\n-\r\n-\r\n-\r\n-\r\n-\r\n-export default router;\r\n"
                },
                {
                    "date": 1753037209240,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -0,0 +1,541 @@\n+//src>routes>member.routes.ts\r\n+import express from 'express';\r\n+import { PrismaClient } from '@prisma/client';\r\n+import { Request, Response } from 'express';\r\n+import { getMembersByTrainer } from '../controllers/member.controller';\r\n+\r\n+const router = express.Router();\r\n+const prisma = new PrismaClient();\r\n+\r\n+\r\n+router.get('/count', async (req, res) => {\r\n+  try {\r\n+    const count = await prisma.member.count({\r\n+      where: { memberType: 'member' },\r\n+    });\r\n+    res.json({ count });\r\n+  } catch (err) {\r\n+    console.error('Error fetching member count:', err);\r\n+    res.status(500).json({ error: 'Failed to fetch member count' });\r\n+  }\r\n+});\r\n+\r\n+\r\n+\r\n+router.get('/search', async (req, res) => {\r\n+  const { q = '', clubId } = req.query;\r\n+\r\n+  if (!clubId) {\r\n+    return res.status(400).json({ error: 'Missing clubId' });\r\n+  }\r\n+\r\n+  try {\r\n+    let members;\r\n+\r\n+    if (q.length === 0) {\r\n+      // Return recent active members when no query provided\r\n+      members = await prisma.member.findMany({\r\n+        where: {\r\n+          clubId: String(clubId),\r\n+          memberType: 'member',\r\n+        },\r\n+        select: {\r\n+          id: true,\r\n+          firstName: true,\r\n+          lastName: true,\r\n+          email: true,\r\n+          keyFob: true,\r\n+        },\r\n+        orderBy: { createdAt: 'desc' },\r\n+        take: 10,\r\n+      });\r\n+    } else {\r\n+      // Perform filtered search\r\n+      members = await prisma.member.findMany({\r\n+        where: {\r\n+          clubId: String(clubId),\r\n+          OR: [\r\n+            { firstName: { contains: String(q), mode: 'insensitive' } },\r\n+            { lastName: { contains: String(q), mode: 'insensitive' } },\r\n+            { email: { contains: String(q), mode: 'insensitive' } },\r\n+            { keyFob: { contains: String(q), mode: 'insensitive' } },\r\n+          ],\r\n+        },\r\n+        select: {\r\n+          id: true,\r\n+          firstName: true,\r\n+          lastName: true,\r\n+          email: true,\r\n+          keyFob: true,\r\n+        },\r\n+        take: 15,\r\n+      });\r\n+    }\r\n+\r\n+    res.json(members);\r\n+  } catch (err) {\r\n+    console.error('Search Error:', err);\r\n+    res.status(500).json({ error: 'Failed to search members' });\r\n+  }\r\n+});\r\n+\r\n+\r\n+router.get('/by-trainer', getMembersByTrainer); \r\n+\r\n+router.post('/', async (req, res) => {\r\n+  try {\r\n+    const {\r\n+      firstName, lastName, email, phone, work, dateOfBirth, gender, avatar,\r\n+      club, keyFob, tags, note, memberType,\r\n+      address, marketing, additional, emergency,\r\n+      medicalInfo,\r\n+    } = req.body;\r\n+\r\n+    const newMember = await prisma.member.create({\r\n+      data: {\r\n+        firstName,\r\n+        lastName,\r\n+        email,\r\n+        phone,\r\n+        work,\r\n+        dateOfBirth: dateOfBirth ? new Date(dateOfBirth) : null,\r\n+        gender,\r\n+        avatarUrl: avatar || null,\r\n+        keyFob,\r\n+        tags,\r\n+        note,\r\n+        memberType,\r\n+\r\n+        // Address\r\n+        street: address?.street || null,\r\n+        city: address?.city || null,\r\n+        state: address?.state || null,\r\n+        zip: address?.zip || null,\r\n+        addressSearch: address?.search || null,\r\n+\r\n+        // Marketing\r\n+        salesRep: marketing?.salesRep || null,\r\n+        sourcePromotion: marketing?.sourcePromotion || null,\r\n+        referredBy: marketing?.referredBy || null,\r\n+\r\n+        // Additional\r\n+        trainerId: additional?.trainerId || null,\r\n+        joiningDate: additional?.joiningDate ? new Date(additional.joiningDate) : null,\r\n+        occupation: additional?.occupation || null,\r\n+        organization: additional?.organization || null,\r\n+        involvementType: additional?.involvementType || null,\r\n+\r\n+        // Emergency\r\n+    \r\n+\r\n+        emergency: emergency || [],\r\n+\r\n+        medicalInfo,\r\n+        clubId: club,\r\n+      },\r\n+    });\r\n+\r\n+    res.status(201).json(newMember);\r\n+  } catch (err) {\r\n+    console.error('Add Member Error:', err);\r\n+    res.status(500).json({ error: 'Failed to create member' });\r\n+  }\r\n+});\r\n+\r\n+\r\n+\r\n+// router.post('/:id/membership', async (req, res) => {\r\n+//   try {\r\n+//     const { id } = req.params;\r\n+//     const { planName, startDate, endDate, autoRenew, status } = req.body;\r\n+\r\n+//     const plan = await prisma.membershipPlan.findUnique({\r\n+//   where: { name: planName },\r\n+// });\r\n+// if (!plan) {\r\n+//   return res.status(400).json({ error: 'Invalid plan selected' });\r\n+// }\r\n+\r\n+\r\n+//     const active = await prisma.membership.findFirst({\r\n+//   where: { memberId: id, status: 'active' }\r\n+\r\n+// });\r\n+\r\n+// if (active) {\r\n+//   return res.status(400).json({\r\n+//     error: 'This member already has an active membership. Please cancel or expire it first.'\r\n+//   });\r\n+// }\r\n+\r\n+//     const membership = await prisma.membership.create({\r\n+//       data: {\r\n+//         planName,\r\n+//         startDate: new Date(startDate),\r\n+//         endDate: new Date(endDate),\r\n+//         autoRenew,\r\n+//         status,\r\n+//         memberId: id,\r\n+//       },\r\n+//     });\r\n+\r\n+//     const member = await prisma.member.findUnique({\r\n+//       where: { id },\r\n+//       select: { clubId: true },\r\n+//     });\r\n+\r\n+//     if (!member) {\r\n+//       return res.status(404).json({ error: 'Member not found' });\r\n+//     }\r\n+\r\n+//     await prisma.invoice.create({\r\n+//   data: {\r\n+//     memberId: id,\r\n+//     planName,\r\n+//     amount: plan.price,\r\n+//     status: 'unpaid',\r\n+//     clubId: member.clubId,\r\n+//     issuedAt: new Date(),\r\n+//     dueDate: new Date(new Date().setDate(new Date().getDate() + 7)),\r\n+//   },\r\n+// });\r\n+\r\n+//     res.status(201).json(membership);\r\n+//   } catch (err) {\r\n+//     console.error('Add Membership Error:', err);\r\n+//     res.status(500).json({ error: 'Failed to create membership' });\r\n+//   }\r\n+// });\r\n+// In your member.routes.ts, update the membership creation route:\r\n+\r\n+router.post('/:id/membership', async (req, res) => {\r\n+  try {\r\n+    const { id } = req.params;\r\n+    const { planName, startDate, endDate, autoRenew, status } = req.body;\r\n+\r\n+    console.log('Creating membership for member:', id);\r\n+    console.log('Request body:', req.body);\r\n+\r\n+    const plan = await prisma.membershipPlan.findUnique({\r\n+      where: { name: planName },\r\n+    });\r\n+    \r\n+    if (!plan) {\r\n+      return res.status(400).json({ error: 'Invalid plan selected' });\r\n+    }\r\n+\r\n+    const active = await prisma.membership.findFirst({\r\n+      where: { memberId: id, status: 'active' }\r\n+    });\r\n+\r\n+    if (active) {\r\n+      return res.status(400).json({\r\n+        error: 'This member already has an active membership. Please cancel or expire it first.'\r\n+      });\r\n+    }\r\n+\r\n+    const membership = await prisma.membership.create({\r\n+      data: {\r\n+        planName,\r\n+        startDate: new Date(startDate),\r\n+        endDate: new Date(endDate),\r\n+        autoRenew,\r\n+        status,\r\n+        memberId: id,\r\n+      },\r\n+    });\r\n+\r\n+    console.log('Membership created:', membership);\r\n+\r\n+    // Get member details\r\n+    const member = await prisma.member.findUnique({\r\n+      where: { id },\r\n+      select: { clubId: true, firstName: true, lastName: true },\r\n+    });\r\n+\r\n+    console.log('Member found:', member);\r\n+\r\n+    if (!member) {\r\n+      return res.status(404).json({ error: 'Member not found' });\r\n+    }\r\n+\r\n+    if (!member.clubId) {\r\n+      return res.status(400).json({ error: 'Member does not have a clubId assigned' });\r\n+    }\r\n+\r\n+    // Create invoice with detailed logging\r\n+    console.log('Creating invoice with data:', {\r\n+      memberId: id,\r\n+      planName,\r\n+      amount: plan.price,\r\n+      status: 'unpaid',\r\n+      clubId: member.clubId,\r\n+      issuedAt: new Date(),\r\n+      dueDate: new Date(new Date().setDate(new Date().getDate() + 7)),\r\n+    });\r\n+\r\n+    try {\r\n+      const invoice = await prisma.invoice.create({\r\n+        data: {\r\n+          memberId: id,\r\n+          planName,\r\n+          amount: plan.price,\r\n+          status: 'unpaid',\r\n+          clubId: member.clubId,\r\n+          issuedAt: new Date(),\r\n+          dueDate: new Date(new Date().setDate(new Date().getDate() + 7)),\r\n+        },\r\n+      });\r\n+\r\n+      console.log('Invoice created successfully:', invoice);\r\n+      \r\n+      res.status(201).json({\r\n+        membership,\r\n+        invoice,\r\n+        message: 'Membership and invoice created successfully'\r\n+      });\r\n+      \r\n+    } catch (invoiceError) {\r\n+      console.error('Invoice creation error:', invoiceError);\r\n+      \r\n+      // If invoice creation fails, we might want to rollback the membership\r\n+      await prisma.membership.delete({\r\n+        where: { id: membership.id }\r\n+      });\r\n+      \r\n+      return res.status(500).json({ \r\n+        error: 'Failed to create invoice', \r\n+        details: invoiceError.message \r\n+      });\r\n+    }\r\n+\r\n+  } catch (err) {\r\n+    console.error('Add Membership Error:', err);\r\n+    res.status(500).json({ \r\n+      error: 'Failed to create membership',\r\n+      details: err.message \r\n+    });\r\n+  }\r\n+});\r\n+\r\n+\r\n+router.get('/', async (req, res) => {\r\n+  try {\r\n+    const { tab = 'all', search = '', page = 1, limit = 10, clubId, trainerId } = req.query;\r\n+    const skip = (Number(page) - 1) * Number(limit);\r\n+\r\n+    let whereClause: any = {\r\n+      clubId: String(clubId),\r\n+    };\r\n+\r\n+    if (trainerId) {\r\n+    whereClause.trainerId = trainerId; // âœ… FILTER BY TRAINER\r\n+  }\r\n+\r\n+    if (search) {\r\n+      whereClause.OR = [\r\n+        { firstName: { contains: search, mode: 'insensitive' } },\r\n+        { lastName: { contains: search, mode: 'insensitive' } },\r\n+        { email: { contains: search, mode: 'insensitive' } },\r\n+      ];\r\n+    }\r\n+\r\n+    switch (tab) {\r\n+      case 'active':\r\n+        whereClause.memberType = 'member';\r\n+        break;\r\n+      case 'expired':\r\n+        whereClause.memberType = 'member';\r\n+        whereClause.keyFob = null;\r\n+        break;\r\n+      case 'prospect':\r\n+        whereClause.memberType = 'prospect';\r\n+        break;\r\n+      case 'recent':\r\n+        const thirtyDaysAgo = new Date();\r\n+        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);\r\n+        whereClause.createdAt = { gte: thirtyDaysAgo };\r\n+        break;\r\n+      default:\r\n+        break;\r\n+    }\r\n+\r\n+    const [members, total] = await Promise.all([\r\n+      prisma.member.findMany({\r\n+        where: whereClause,\r\n+        orderBy: { createdAt: 'desc' },\r\n+        skip,\r\n+        take: Number(limit),\r\n+      }),\r\n+      prisma.member.count({ where: whereClause }),\r\n+    ]);\r\n+\r\n+    res.json({\r\n+      data: members,\r\n+      meta: {\r\n+        total,\r\n+        page: Number(page),\r\n+        pageSize: Number(limit),\r\n+      },\r\n+    });\r\n+  } catch (err) {\r\n+    console.error(err);\r\n+    res.status(500).json({ error: 'Failed to fetch members' });\r\n+  }\r\n+});\r\n+\r\n+router.get('/upcoming-renewals', async (req, res) => {\r\n+  const { clubId, days = 7 } = req.query;\r\n+\r\n+  if (!clubId) return res.status(400).json({ error: 'Missing clubId' });\r\n+\r\n+  const upcomingDate = new Date();\r\n+  upcomingDate.setDate(upcomingDate.getDate() + Number(days));\r\n+\r\n+  try {\r\n+    const count = await prisma.membership.count({\r\n+      where: {\r\n+        member: { clubId: String(clubId) },\r\n+        endDate: {\r\n+          gte: new Date(),\r\n+          lte: upcomingDate,\r\n+        },\r\n+        status: 'active',\r\n+      },\r\n+    });\r\n+\r\n+    res.json({ count });\r\n+  } catch (error) {\r\n+    console.error('Error fetching upcoming renewals:', error);\r\n+    res.status(500).json({ error: 'Failed to fetch upcoming renewals' });\r\n+  }\r\n+});\r\n+\r\n+\r\n+// GET /api/members/:id\r\n+router.get('/:id', async (req, res) => {\r\n+  const { id } = req.params;\r\n+\r\n+  try {\r\n+    const member = await prisma.member.findUnique({\r\n+      where: { id },\r\n+      include: {\r\n+        trainer: true,\r\n+        club: true,\r\n+        membership: {\r\n+      orderBy: { startDate: 'desc' }, // Get most recent first\r\n+      take: 1,                        // Optional: only return one latest\r\n+    },\r\n+      },\r\n+    });\r\n+\r\n+      console.log('ðŸ‘¨â€âš•ï¸ Full member details:', member); // âœ… ADD THIS\r\n+\r\n+    if (!member) return res.status(404).json({ error: 'Member not found' });\r\n+\r\n+    res.json(member);\r\n+  } catch (err) {\r\n+    console.error('Fetch member detail error:', err);\r\n+    res.status(500).json({ error: 'Failed to fetch member details' });\r\n+  }\r\n+});\r\n+\r\n+//update member\r\n+\r\n+// PUT /api/members/:id\r\n+router.put('/:id', async (req: Request, res: Response) => {\r\n+  try {\r\n+    const { id } = req.params;\r\n+    const updatedData = req.body;\r\n+\r\n+    const updated = await prisma.member.update({\r\n+      where: { id },\r\n+      data: {\r\n+        firstName: updatedData.firstName,\r\n+        lastName: updatedData.lastName,\r\n+        email: updatedData.email,\r\n+        phone: updatedData.phone,\r\n+        work: updatedData.work,\r\n+        dateOfBirth: updatedData.dateOfBirth ? new Date(updatedData.dateOfBirth) : null,\r\n+        gender: updatedData.gender,\r\n+        avatarUrl: updatedData.avatar || null,\r\n+        keyFob: updatedData.keyFob,\r\n+        tags: updatedData.tags,\r\n+        note: updatedData.note,\r\n+        memberType: updatedData.memberType,\r\n+\r\n+        // Address\r\n+        street: updatedData.address?.street || null,\r\n+        city: updatedData.address?.city || null,\r\n+        state: updatedData.address?.state || null,\r\n+        zip: updatedData.address?.zip || null,\r\n+        addressSearch: updatedData.address?.search || null,\r\n+\r\n+        // Marketing\r\n+        salesRep: updatedData.marketing?.salesRep || null,\r\n+        sourcePromotion: updatedData.marketing?.sourcePromotion || null,\r\n+        referredBy: updatedData.marketing?.referredBy || null,\r\n+\r\n+        // Additional\r\n+        trainerId: updatedData.additional?.trainerId || null,\r\n+        joiningDate: updatedData.additional?.joiningDate ? new Date(updatedData.additional.joiningDate) : null,\r\n+        occupation: updatedData.additional?.occupation || null,\r\n+        organization: updatedData.additional?.organization || null,\r\n+        involvementType: updatedData.additional?.involvementType || null,\r\n+\r\n+        // Emergency\r\n+        emergency: updatedData.emergency || [],\r\n+//medical information\r\n+        medicalInfo: updatedData.medicalInfo || '',\r\n+allergies: updatedData.allergies || '',\r\n+medications: updatedData.medications || '',\r\n+chronicConditions: updatedData.chronicConditions || '',\r\n+injuries: updatedData.injuries || '',\r\n+doctorContact: updatedData.doctorContact || '',\r\n+lastExamDate: updatedData.lastExamDate ? new Date(updatedData.lastExamDate) : null,\r\n+        clubId: updatedData.club,\r\n+      },\r\n+    });\r\n+\r\n+    return res.status(200).json(updated);\r\n+  } catch (err) {\r\n+    console.error('Error updating member:', err);\r\n+    return res.status(500).json({ error: 'Failed to update member' });\r\n+  }\r\n+});\r\n+\r\n+// GET /api/members/:id/sessions - All attendance sessions for a member\r\n+router.get('/:id/sessions', async (req, res) => {\r\n+  const { id } = req.params;\r\n+\r\n+  try {\r\n+    const attendanceRecords = await prisma.attendance.findMany({\r\n+      where: { memberId: id },\r\n+      orderBy: { markedAt: 'desc' },\r\n+      include: {\r\n+        schedule: {\r\n+          include: {\r\n+            trainer: { select: { name: true } },\r\n+            location: { select: { name: true } }\r\n+          }\r\n+        }\r\n+      }\r\n+    });\r\n+\r\n+    res.json(attendanceRecords);\r\n+  } catch (err) {\r\n+    console.error('Error fetching session history:', err);\r\n+    res.status(500).json({ error: 'Failed to fetch session history' });\r\n+  }\r\n+});\r\n+\r\n+\r\n+\r\n+\r\n+\r\n+\r\n+\r\n+\r\n+\r\n+\r\n+export default router;\r\n"
                },
                {
                    "date": 1753043772547,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -528,14 +528,39 @@\n     res.status(500).json({ error: 'Failed to fetch session history' });\r\n   }\r\n });\r\n \r\n+router.get('/stats/joined', async (req, res) => {\r\n+  const { days = '30', clubId } = req.query;\r\n \r\n+  if (!clubId) return res.status(400).json({ error: 'Missing clubId' });\r\n \r\n+  const fromDate = new Date();\r\n+  fromDate.setDate(fromDate.getDate() - parseInt(days as string));\r\n \r\n+  try {\r\n+    const results = await prisma.$queryRawUnsafe(`\r\n+      SELECT DATE(\"createdAt\") AS date, COUNT(*) AS count\r\n+      FROM \"Member\"\r\n+      WHERE \"clubId\" = '${clubId}' AND \"createdAt\" >= '${fromDate.toISOString()}'\r\n+      GROUP BY DATE(\"createdAt\")\r\n+      ORDER BY DATE(\"createdAt\") ASC\r\n+    `);\r\n \r\n+    res.json(results);\r\n+  } catch (err) {\r\n+    console.error('Join stats error:', err);\r\n+    res.status(500).json({ error: 'Failed to get join stats' });\r\n+  }\r\n+});\r\n \r\n \r\n \r\n \r\n \r\n+\r\n+\r\n+\r\n+\r\n+\r\n+\r\n export default router;\r\n"
                },
                {
                    "date": 1753043876339,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -0,0 +1,600 @@\n+//src>routes>member.routes.ts\r\n+import express from 'express';\r\n+import { PrismaClient } from '@prisma/client';\r\n+import { Request, Response } from 'express';\r\n+import { getMembersByTrainer } from '../controllers/member.controller';\r\n+\r\n+const router = express.Router();\r\n+const prisma = new PrismaClient();\r\n+\r\n+\r\n+router.get('/count', async (req, res) => {\r\n+  try {\r\n+    const count = await prisma.member.count({\r\n+      where: { memberType: 'member' },\r\n+    });\r\n+    res.json({ count });\r\n+  } catch (err) {\r\n+    console.error('Error fetching member count:', err);\r\n+    res.status(500).json({ error: 'Failed to fetch member count' });\r\n+  }\r\n+});\r\n+\r\n+\r\n+\r\n+router.get('/search', async (req, res) => {\r\n+  const { q = '', clubId } = req.query;\r\n+\r\n+  if (!clubId) {\r\n+    return res.status(400).json({ error: 'Missing clubId' });\r\n+  }\r\n+\r\n+  try {\r\n+    let members;\r\n+\r\n+    if (q.length === 0) {\r\n+      // Return recent active members when no query provided\r\n+      members = await prisma.member.findMany({\r\n+        where: {\r\n+          clubId: String(clubId),\r\n+          memberType: 'member',\r\n+        },\r\n+        select: {\r\n+          id: true,\r\n+          firstName: true,\r\n+          lastName: true,\r\n+          email: true,\r\n+          keyFob: true,\r\n+        },\r\n+        orderBy: { createdAt: 'desc' },\r\n+        take: 10,\r\n+      });\r\n+    } else {\r\n+      // Perform filtered search\r\n+      members = await prisma.member.findMany({\r\n+        where: {\r\n+          clubId: String(clubId),\r\n+          OR: [\r\n+            { firstName: { contains: String(q), mode: 'insensitive' } },\r\n+            { lastName: { contains: String(q), mode: 'insensitive' } },\r\n+            { email: { contains: String(q), mode: 'insensitive' } },\r\n+            { keyFob: { contains: String(q), mode: 'insensitive' } },\r\n+          ],\r\n+        },\r\n+        select: {\r\n+          id: true,\r\n+          firstName: true,\r\n+          lastName: true,\r\n+          email: true,\r\n+          keyFob: true,\r\n+        },\r\n+        take: 15,\r\n+      });\r\n+    }\r\n+\r\n+    res.json(members);\r\n+  } catch (err) {\r\n+    console.error('Search Error:', err);\r\n+    res.status(500).json({ error: 'Failed to search members' });\r\n+  }\r\n+});\r\n+\r\n+\r\n+router.get('/by-trainer', getMembersByTrainer); \r\n+\r\n+router.post('/', async (req, res) => {\r\n+  try {\r\n+    const {\r\n+      firstName, lastName, email, phone, work, dateOfBirth, gender, avatar,\r\n+      club, keyFob, tags, note, memberType,\r\n+      address, marketing, additional, emergency,\r\n+      medicalInfo,\r\n+    } = req.body;\r\n+\r\n+    const newMember = await prisma.member.create({\r\n+      data: {\r\n+        firstName,\r\n+        lastName,\r\n+        email,\r\n+        phone,\r\n+        work,\r\n+        dateOfBirth: dateOfBirth ? new Date(dateOfBirth) : null,\r\n+        gender,\r\n+        avatarUrl: avatar || null,\r\n+        keyFob,\r\n+        tags,\r\n+        note,\r\n+        memberType,\r\n+\r\n+        // Address\r\n+        street: address?.street || null,\r\n+        city: address?.city || null,\r\n+        state: address?.state || null,\r\n+        zip: address?.zip || null,\r\n+        addressSearch: address?.search || null,\r\n+\r\n+        // Marketing\r\n+        salesRep: marketing?.salesRep || null,\r\n+        sourcePromotion: marketing?.sourcePromotion || null,\r\n+        referredBy: marketing?.referredBy || null,\r\n+\r\n+        // Additional\r\n+        trainerId: additional?.trainerId || null,\r\n+        joiningDate: additional?.joiningDate ? new Date(additional.joiningDate) : null,\r\n+        occupation: additional?.occupation || null,\r\n+        organization: additional?.organization || null,\r\n+        involvementType: additional?.involvementType || null,\r\n+\r\n+        // Emergency\r\n+    \r\n+\r\n+        emergency: emergency || [],\r\n+\r\n+        medicalInfo,\r\n+        clubId: club,\r\n+      },\r\n+    });\r\n+\r\n+    res.status(201).json(newMember);\r\n+  } catch (err) {\r\n+    console.error('Add Member Error:', err);\r\n+    res.status(500).json({ error: 'Failed to create member' });\r\n+  }\r\n+});\r\n+\r\n+\r\n+\r\n+// router.post('/:id/membership', async (req, res) => {\r\n+//   try {\r\n+//     const { id } = req.params;\r\n+//     const { planName, startDate, endDate, autoRenew, status } = req.body;\r\n+\r\n+//     const plan = await prisma.membershipPlan.findUnique({\r\n+//   where: { name: planName },\r\n+// });\r\n+// if (!plan) {\r\n+//   return res.status(400).json({ error: 'Invalid plan selected' });\r\n+// }\r\n+\r\n+\r\n+//     const active = await prisma.membership.findFirst({\r\n+//   where: { memberId: id, status: 'active' }\r\n+\r\n+// });\r\n+\r\n+// if (active) {\r\n+//   return res.status(400).json({\r\n+//     error: 'This member already has an active membership. Please cancel or expire it first.'\r\n+//   });\r\n+// }\r\n+\r\n+//     const membership = await prisma.membership.create({\r\n+//       data: {\r\n+//         planName,\r\n+//         startDate: new Date(startDate),\r\n+//         endDate: new Date(endDate),\r\n+//         autoRenew,\r\n+//         status,\r\n+//         memberId: id,\r\n+//       },\r\n+//     });\r\n+\r\n+//     const member = await prisma.member.findUnique({\r\n+//       where: { id },\r\n+//       select: { clubId: true },\r\n+//     });\r\n+\r\n+//     if (!member) {\r\n+//       return res.status(404).json({ error: 'Member not found' });\r\n+//     }\r\n+\r\n+//     await prisma.invoice.create({\r\n+//   data: {\r\n+//     memberId: id,\r\n+//     planName,\r\n+//     amount: plan.price,\r\n+//     status: 'unpaid',\r\n+//     clubId: member.clubId,\r\n+//     issuedAt: new Date(),\r\n+//     dueDate: new Date(new Date().setDate(new Date().getDate() + 7)),\r\n+//   },\r\n+// });\r\n+\r\n+//     res.status(201).json(membership);\r\n+//   } catch (err) {\r\n+//     console.error('Add Membership Error:', err);\r\n+//     res.status(500).json({ error: 'Failed to create membership' });\r\n+//   }\r\n+// });\r\n+// In your member.routes.ts, update the membership creation route:\r\n+\r\n+router.post('/:id/membership', async (req, res) => {\r\n+  try {\r\n+    const { id } = req.params;\r\n+    const { planName, startDate, endDate, autoRenew, status } = req.body;\r\n+\r\n+    console.log('Creating membership for member:', id);\r\n+    console.log('Request body:', req.body);\r\n+\r\n+    const plan = await prisma.membershipPlan.findUnique({\r\n+      where: { name: planName },\r\n+    });\r\n+    \r\n+    if (!plan) {\r\n+      return res.status(400).json({ error: 'Invalid plan selected' });\r\n+    }\r\n+\r\n+    const active = await prisma.membership.findFirst({\r\n+      where: { memberId: id, status: 'active' }\r\n+    });\r\n+\r\n+    if (active) {\r\n+      return res.status(400).json({\r\n+        error: 'This member already has an active membership. Please cancel or expire it first.'\r\n+      });\r\n+    }\r\n+\r\n+    const membership = await prisma.membership.create({\r\n+      data: {\r\n+        planName,\r\n+        startDate: new Date(startDate),\r\n+        endDate: new Date(endDate),\r\n+        autoRenew,\r\n+        status,\r\n+        memberId: id,\r\n+      },\r\n+    });\r\n+\r\n+    console.log('Membership created:', membership);\r\n+\r\n+    // Get member details\r\n+    const member = await prisma.member.findUnique({\r\n+      where: { id },\r\n+      select: { clubId: true, firstName: true, lastName: true },\r\n+    });\r\n+\r\n+    console.log('Member found:', member);\r\n+\r\n+    if (!member) {\r\n+      return res.status(404).json({ error: 'Member not found' });\r\n+    }\r\n+\r\n+    if (!member.clubId) {\r\n+      return res.status(400).json({ error: 'Member does not have a clubId assigned' });\r\n+    }\r\n+\r\n+    // Create invoice with detailed logging\r\n+    console.log('Creating invoice with data:', {\r\n+      memberId: id,\r\n+      planName,\r\n+      amount: plan.price,\r\n+      status: 'unpaid',\r\n+      clubId: member.clubId,\r\n+      issuedAt: new Date(),\r\n+      dueDate: new Date(new Date().setDate(new Date().getDate() + 7)),\r\n+    });\r\n+\r\n+    try {\r\n+      const invoice = await prisma.invoice.create({\r\n+        data: {\r\n+          memberId: id,\r\n+          planName,\r\n+          amount: plan.price,\r\n+          status: 'unpaid',\r\n+          clubId: member.clubId,\r\n+          issuedAt: new Date(),\r\n+          dueDate: new Date(new Date().setDate(new Date().getDate() + 7)),\r\n+        },\r\n+      });\r\n+\r\n+      console.log('Invoice created successfully:', invoice);\r\n+      \r\n+      res.status(201).json({\r\n+        membership,\r\n+        invoice,\r\n+        message: 'Membership and invoice created successfully'\r\n+      });\r\n+      \r\n+    } catch (invoiceError) {\r\n+      console.error('Invoice creation error:', invoiceError);\r\n+      \r\n+      // If invoice creation fails, we might want to rollback the membership\r\n+      await prisma.membership.delete({\r\n+        where: { id: membership.id }\r\n+      });\r\n+      \r\n+      return res.status(500).json({ \r\n+        error: 'Failed to create invoice', \r\n+        details: invoiceError.message \r\n+      });\r\n+    }\r\n+\r\n+  } catch (err) {\r\n+    console.error('Add Membership Error:', err);\r\n+    res.status(500).json({ \r\n+      error: 'Failed to create membership',\r\n+      details: err.message \r\n+    });\r\n+  }\r\n+});\r\n+\r\n+\r\n+router.get('/', async (req, res) => {\r\n+  try {\r\n+    const { tab = 'all', search = '', page = 1, limit = 10, clubId, trainerId } = req.query;\r\n+    const skip = (Number(page) - 1) * Number(limit);\r\n+\r\n+    let whereClause: any = {\r\n+      clubId: String(clubId),\r\n+    };\r\n+\r\n+    if (trainerId) {\r\n+    whereClause.trainerId = trainerId; // âœ… FILTER BY TRAINER\r\n+  }\r\n+\r\n+    if (search) {\r\n+      whereClause.OR = [\r\n+        { firstName: { contains: search, mode: 'insensitive' } },\r\n+        { lastName: { contains: search, mode: 'insensitive' } },\r\n+        { email: { contains: search, mode: 'insensitive' } },\r\n+      ];\r\n+    }\r\n+\r\n+    switch (tab) {\r\n+      case 'active':\r\n+        whereClause.memberType = 'member';\r\n+        break;\r\n+      case 'expired':\r\n+        whereClause.memberType = 'member';\r\n+        whereClause.keyFob = null;\r\n+        break;\r\n+      case 'prospect':\r\n+        whereClause.memberType = 'prospect';\r\n+        break;\r\n+      case 'recent':\r\n+        const thirtyDaysAgo = new Date();\r\n+        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);\r\n+        whereClause.createdAt = { gte: thirtyDaysAgo };\r\n+        break;\r\n+      default:\r\n+        break;\r\n+    }\r\n+\r\n+    const [members, total] = await Promise.all([\r\n+      prisma.member.findMany({\r\n+        where: whereClause,\r\n+        orderBy: { createdAt: 'desc' },\r\n+        skip,\r\n+        take: Number(limit),\r\n+      }),\r\n+      prisma.member.count({ where: whereClause }),\r\n+    ]);\r\n+\r\n+    res.json({\r\n+      data: members,\r\n+      meta: {\r\n+        total,\r\n+        page: Number(page),\r\n+        pageSize: Number(limit),\r\n+      },\r\n+    });\r\n+  } catch (err) {\r\n+    console.error(err);\r\n+    res.status(500).json({ error: 'Failed to fetch members' });\r\n+  }\r\n+});\r\n+\r\n+router.get('/upcoming-renewals', async (req, res) => {\r\n+  const { clubId, days = 7 } = req.query;\r\n+\r\n+  if (!clubId) return res.status(400).json({ error: 'Missing clubId' });\r\n+\r\n+  const upcomingDate = new Date();\r\n+  upcomingDate.setDate(upcomingDate.getDate() + Number(days));\r\n+\r\n+  try {\r\n+    const count = await prisma.membership.count({\r\n+      where: {\r\n+        member: { clubId: String(clubId) },\r\n+        endDate: {\r\n+          gte: new Date(),\r\n+          lte: upcomingDate,\r\n+        },\r\n+        status: 'active',\r\n+      },\r\n+    });\r\n+\r\n+    res.json({ count });\r\n+  } catch (error) {\r\n+    console.error('Error fetching upcoming renewals:', error);\r\n+    res.status(500).json({ error: 'Failed to fetch upcoming renewals' });\r\n+  }\r\n+});\r\n+\r\n+\r\n+// GET /api/members/:id\r\n+router.get('/:id', async (req, res) => {\r\n+  const { id } = req.params;\r\n+\r\n+  try {\r\n+    const member = await prisma.member.findUnique({\r\n+      where: { id },\r\n+      include: {\r\n+        trainer: true,\r\n+        club: true,\r\n+        membership: {\r\n+      orderBy: { startDate: 'desc' }, // Get most recent first\r\n+      take: 1,                        // Optional: only return one latest\r\n+    },\r\n+      },\r\n+    });\r\n+\r\n+      console.log('ðŸ‘¨â€âš•ï¸ Full member details:', member); // âœ… ADD THIS\r\n+\r\n+    if (!member) return res.status(404).json({ error: 'Member not found' });\r\n+\r\n+    res.json(member);\r\n+  } catch (err) {\r\n+    console.error('Fetch member detail error:', err);\r\n+    res.status(500).json({ error: 'Failed to fetch member details' });\r\n+  }\r\n+});\r\n+\r\n+//update member\r\n+\r\n+// PUT /api/members/:id\r\n+router.put('/:id', async (req: Request, res: Response) => {\r\n+  try {\r\n+    const { id } = req.params;\r\n+    const updatedData = req.body;\r\n+\r\n+    const updated = await prisma.member.update({\r\n+      where: { id },\r\n+      data: {\r\n+        firstName: updatedData.firstName,\r\n+        lastName: updatedData.lastName,\r\n+        email: updatedData.email,\r\n+        phone: updatedData.phone,\r\n+        work: updatedData.work,\r\n+        dateOfBirth: updatedData.dateOfBirth ? new Date(updatedData.dateOfBirth) : null,\r\n+        gender: updatedData.gender,\r\n+        avatarUrl: updatedData.avatar || null,\r\n+        keyFob: updatedData.keyFob,\r\n+        tags: updatedData.tags,\r\n+        note: updatedData.note,\r\n+        memberType: updatedData.memberType,\r\n+\r\n+        // Address\r\n+        street: updatedData.address?.street || null,\r\n+        city: updatedData.address?.city || null,\r\n+        state: updatedData.address?.state || null,\r\n+        zip: updatedData.address?.zip || null,\r\n+        addressSearch: updatedData.address?.search || null,\r\n+\r\n+        // Marketing\r\n+        salesRep: updatedData.marketing?.salesRep || null,\r\n+        sourcePromotion: updatedData.marketing?.sourcePromotion || null,\r\n+        referredBy: updatedData.marketing?.referredBy || null,\r\n+\r\n+        // Additional\r\n+        trainerId: updatedData.additional?.trainerId || null,\r\n+        joiningDate: updatedData.additional?.joiningDate ? new Date(updatedData.additional.joiningDate) : null,\r\n+        occupation: updatedData.additional?.occupation || null,\r\n+        organization: updatedData.additional?.organization || null,\r\n+        involvementType: updatedData.additional?.involvementType || null,\r\n+\r\n+        // Emergency\r\n+        emergency: updatedData.emergency || [],\r\n+//medical information\r\n+        medicalInfo: updatedData.medicalInfo || '',\r\n+allergies: updatedData.allergies || '',\r\n+medications: updatedData.medications || '',\r\n+chronicConditions: updatedData.chronicConditions || '',\r\n+injuries: updatedData.injuries || '',\r\n+doctorContact: updatedData.doctorContact || '',\r\n+lastExamDate: updatedData.lastExamDate ? new Date(updatedData.lastExamDate) : null,\r\n+        clubId: updatedData.club,\r\n+      },\r\n+    });\r\n+\r\n+    return res.status(200).json(updated);\r\n+  } catch (err) {\r\n+    console.error('Error updating member:', err);\r\n+    return res.status(500).json({ error: 'Failed to update member' });\r\n+  }\r\n+});\r\n+\r\n+// GET /api/members/:id/sessions - All attendance sessions for a member\r\n+router.get('/:id/sessions', async (req, res) => {\r\n+  const { id } = req.params;\r\n+\r\n+  try {\r\n+    const attendanceRecords = await prisma.attendance.findMany({\r\n+      where: { memberId: id },\r\n+      orderBy: { markedAt: 'desc' },\r\n+      include: {\r\n+        schedule: {\r\n+          include: {\r\n+            trainer: { select: { name: true } },\r\n+            location: { select: { name: true } }\r\n+          }\r\n+        }\r\n+      }\r\n+    });\r\n+\r\n+    res.json(attendanceRecords);\r\n+  } catch (err) {\r\n+    console.error('Error fetching session history:', err);\r\n+    res.status(500).json({ error: 'Failed to fetch session history' });\r\n+  }\r\n+});\r\n+\r\n+router.get('/stats/joined', async (req, res) => {\r\n+  const { days = '30', clubId } = req.query;\r\n+\r\n+  if (!clubId) return res.status(400).json({ error: 'Missing clubId' });\r\n+\r\n+  const fromDate = new Date();\r\n+  fromDate.setDate(fromDate.getDate() - parseInt(days as string));\r\n+\r\n+  try {\r\n+    const results = await prisma.$queryRawUnsafe(`\r\n+      SELECT DATE(\"createdAt\") AS date, COUNT(*) AS count\r\n+      FROM \"Member\"\r\n+      WHERE \"clubId\" = '${clubId}' AND \"createdAt\" >= '${fromDate.toISOString()}'\r\n+      GROUP BY DATE(\"createdAt\")\r\n+      ORDER BY DATE(\"createdAt\") ASC\r\n+    `);\r\n+\r\n+    res.json(results);\r\n+  } catch (err) {\r\n+    console.error('Join stats error:', err);\r\n+    res.status(500).json({ error: 'Failed to get join stats' });\r\n+  }\r\n+});\r\n+\r\n+// GET /api/billing/revenue-trend\r\n+router.get('/revenue-trend', async (req, res) => {\r\n+  const { clubId } = req.query;\r\n+\r\n+  if (!clubId) return res.status(400).json({ error: 'Missing clubId' });\r\n+\r\n+  try {\r\n+    const results = await prisma.invoice.groupBy({\r\n+      by: ['issuedAt'],\r\n+      where: {\r\n+        clubId: String(clubId),\r\n+        status: 'paid',\r\n+      },\r\n+      _sum: {\r\n+        amount: true,\r\n+      },\r\n+      orderBy: {\r\n+        issuedAt: 'asc',\r\n+      },\r\n+    });\r\n+\r\n+    const trend = results.map((r) => ({\r\n+      date: r.issuedAt.toISOString().split('T')[0],\r\n+      revenue: r._sum.amount ?? 0,\r\n+    }));\r\n+\r\n+    res.json(trend);\r\n+  } catch (err) {\r\n+    console.error('Revenue trend error:', err);\r\n+    res.status(500).json({ error: 'Failed to fetch revenue trend' });\r\n+  }\r\n+});\r\n+\r\n+\r\n+\r\n+\r\n+\r\n+\r\n+\r\n+\r\n+\r\n+\r\n+\r\n+\r\n+export default router;\r\n"
                },
                {
                    "date": 1753044109638,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -0,0 +1,613 @@\n+//src>routes>member.routes.ts\r\n+import express from 'express';\r\n+import { PrismaClient } from '@prisma/client';\r\n+import { Request, Response } from 'express';\r\n+import { getMembersByTrainer } from '../controllers/member.controller';\r\n+\r\n+const router = express.Router();\r\n+const prisma = new PrismaClient();\r\n+\r\n+\r\n+router.get('/count', async (req, res) => {\r\n+  try {\r\n+    const count = await prisma.member.count({\r\n+      where: { memberType: 'member' },\r\n+    });\r\n+    res.json({ count });\r\n+  } catch (err) {\r\n+    console.error('Error fetching member count:', err);\r\n+    res.status(500).json({ error: 'Failed to fetch member count' });\r\n+  }\r\n+});\r\n+\r\n+\r\n+\r\n+router.get('/search', async (req, res) => {\r\n+  const { q = '', clubId } = req.query;\r\n+\r\n+  if (!clubId) {\r\n+    return res.status(400).json({ error: 'Missing clubId' });\r\n+  }\r\n+\r\n+  try {\r\n+    let members;\r\n+\r\n+    if (q.length === 0) {\r\n+      // Return recent active members when no query provided\r\n+      members = await prisma.member.findMany({\r\n+        where: {\r\n+          clubId: String(clubId),\r\n+          memberType: 'member',\r\n+        },\r\n+        select: {\r\n+          id: true,\r\n+          firstName: true,\r\n+          lastName: true,\r\n+          email: true,\r\n+          keyFob: true,\r\n+        },\r\n+        orderBy: { createdAt: 'desc' },\r\n+        take: 10,\r\n+      });\r\n+    } else {\r\n+      // Perform filtered search\r\n+      members = await prisma.member.findMany({\r\n+        where: {\r\n+          clubId: String(clubId),\r\n+          OR: [\r\n+            { firstName: { contains: String(q), mode: 'insensitive' } },\r\n+            { lastName: { contains: String(q), mode: 'insensitive' } },\r\n+            { email: { contains: String(q), mode: 'insensitive' } },\r\n+            { keyFob: { contains: String(q), mode: 'insensitive' } },\r\n+          ],\r\n+        },\r\n+        select: {\r\n+          id: true,\r\n+          firstName: true,\r\n+          lastName: true,\r\n+          email: true,\r\n+          keyFob: true,\r\n+        },\r\n+        take: 15,\r\n+      });\r\n+    }\r\n+\r\n+    res.json(members);\r\n+  } catch (err) {\r\n+    console.error('Search Error:', err);\r\n+    res.status(500).json({ error: 'Failed to search members' });\r\n+  }\r\n+});\r\n+\r\n+\r\n+router.get('/by-trainer', getMembersByTrainer); \r\n+\r\n+router.post('/', async (req, res) => {\r\n+  try {\r\n+    const {\r\n+      firstName, lastName, email, phone, work, dateOfBirth, gender, avatar,\r\n+      club, keyFob, tags, note, memberType,\r\n+      address, marketing, additional, emergency,\r\n+      medicalInfo,\r\n+    } = req.body;\r\n+\r\n+    const newMember = await prisma.member.create({\r\n+      data: {\r\n+        firstName,\r\n+        lastName,\r\n+        email,\r\n+        phone,\r\n+        work,\r\n+        dateOfBirth: dateOfBirth ? new Date(dateOfBirth) : null,\r\n+        gender,\r\n+        avatarUrl: avatar || null,\r\n+        keyFob,\r\n+        tags,\r\n+        note,\r\n+        memberType,\r\n+\r\n+        // Address\r\n+        street: address?.street || null,\r\n+        city: address?.city || null,\r\n+        state: address?.state || null,\r\n+        zip: address?.zip || null,\r\n+        addressSearch: address?.search || null,\r\n+\r\n+        // Marketing\r\n+        salesRep: marketing?.salesRep || null,\r\n+        sourcePromotion: marketing?.sourcePromotion || null,\r\n+        referredBy: marketing?.referredBy || null,\r\n+\r\n+        // Additional\r\n+        trainerId: additional?.trainerId || null,\r\n+        joiningDate: additional?.joiningDate ? new Date(additional.joiningDate) : null,\r\n+        occupation: additional?.occupation || null,\r\n+        organization: additional?.organization || null,\r\n+        involvementType: additional?.involvementType || null,\r\n+\r\n+        // Emergency\r\n+    \r\n+\r\n+        emergency: emergency || [],\r\n+\r\n+        medicalInfo,\r\n+        clubId: club,\r\n+      },\r\n+    });\r\n+\r\n+    res.status(201).json(newMember);\r\n+  } catch (err) {\r\n+    console.error('Add Member Error:', err);\r\n+    res.status(500).json({ error: 'Failed to create member' });\r\n+  }\r\n+});\r\n+\r\n+\r\n+\r\n+// router.post('/:id/membership', async (req, res) => {\r\n+//   try {\r\n+//     const { id } = req.params;\r\n+//     const { planName, startDate, endDate, autoRenew, status } = req.body;\r\n+\r\n+//     const plan = await prisma.membershipPlan.findUnique({\r\n+//   where: { name: planName },\r\n+// });\r\n+// if (!plan) {\r\n+//   return res.status(400).json({ error: 'Invalid plan selected' });\r\n+// }\r\n+\r\n+\r\n+//     const active = await prisma.membership.findFirst({\r\n+//   where: { memberId: id, status: 'active' }\r\n+\r\n+// });\r\n+\r\n+// if (active) {\r\n+//   return res.status(400).json({\r\n+//     error: 'This member already has an active membership. Please cancel or expire it first.'\r\n+//   });\r\n+// }\r\n+\r\n+//     const membership = await prisma.membership.create({\r\n+//       data: {\r\n+//         planName,\r\n+//         startDate: new Date(startDate),\r\n+//         endDate: new Date(endDate),\r\n+//         autoRenew,\r\n+//         status,\r\n+//         memberId: id,\r\n+//       },\r\n+//     });\r\n+\r\n+//     const member = await prisma.member.findUnique({\r\n+//       where: { id },\r\n+//       select: { clubId: true },\r\n+//     });\r\n+\r\n+//     if (!member) {\r\n+//       return res.status(404).json({ error: 'Member not found' });\r\n+//     }\r\n+\r\n+//     await prisma.invoice.create({\r\n+//   data: {\r\n+//     memberId: id,\r\n+//     planName,\r\n+//     amount: plan.price,\r\n+//     status: 'unpaid',\r\n+//     clubId: member.clubId,\r\n+//     issuedAt: new Date(),\r\n+//     dueDate: new Date(new Date().setDate(new Date().getDate() + 7)),\r\n+//   },\r\n+// });\r\n+\r\n+//     res.status(201).json(membership);\r\n+//   } catch (err) {\r\n+//     console.error('Add Membership Error:', err);\r\n+//     res.status(500).json({ error: 'Failed to create membership' });\r\n+//   }\r\n+// });\r\n+// In your member.routes.ts, update the membership creation route:\r\n+\r\n+router.post('/:id/membership', async (req, res) => {\r\n+  try {\r\n+    const { id } = req.params;\r\n+    const { planName, startDate, endDate, autoRenew, status } = req.body;\r\n+\r\n+    console.log('Creating membership for member:', id);\r\n+    console.log('Request body:', req.body);\r\n+\r\n+    const plan = await prisma.membershipPlan.findUnique({\r\n+      where: { name: planName },\r\n+    });\r\n+    \r\n+    if (!plan) {\r\n+      return res.status(400).json({ error: 'Invalid plan selected' });\r\n+    }\r\n+\r\n+    const active = await prisma.membership.findFirst({\r\n+      where: { memberId: id, status: 'active' }\r\n+    });\r\n+\r\n+    if (active) {\r\n+      return res.status(400).json({\r\n+        error: 'This member already has an active membership. Please cancel or expire it first.'\r\n+      });\r\n+    }\r\n+\r\n+    const membership = await prisma.membership.create({\r\n+      data: {\r\n+        planName,\r\n+        startDate: new Date(startDate),\r\n+        endDate: new Date(endDate),\r\n+        autoRenew,\r\n+        status,\r\n+        memberId: id,\r\n+      },\r\n+    });\r\n+\r\n+    console.log('Membership created:', membership);\r\n+\r\n+    // Get member details\r\n+    const member = await prisma.member.findUnique({\r\n+      where: { id },\r\n+      select: { clubId: true, firstName: true, lastName: true },\r\n+    });\r\n+\r\n+    console.log('Member found:', member);\r\n+\r\n+    if (!member) {\r\n+      return res.status(404).json({ error: 'Member not found' });\r\n+    }\r\n+\r\n+    if (!member.clubId) {\r\n+      return res.status(400).json({ error: 'Member does not have a clubId assigned' });\r\n+    }\r\n+\r\n+    // Create invoice with detailed logging\r\n+    console.log('Creating invoice with data:', {\r\n+      memberId: id,\r\n+      planName,\r\n+      amount: plan.price,\r\n+      status: 'unpaid',\r\n+      clubId: member.clubId,\r\n+      issuedAt: new Date(),\r\n+      dueDate: new Date(new Date().setDate(new Date().getDate() + 7)),\r\n+    });\r\n+\r\n+    try {\r\n+      const invoice = await prisma.invoice.create({\r\n+        data: {\r\n+          memberId: id,\r\n+          planName,\r\n+          amount: plan.price,\r\n+          status: 'unpaid',\r\n+          clubId: member.clubId,\r\n+          issuedAt: new Date(),\r\n+          dueDate: new Date(new Date().setDate(new Date().getDate() + 7)),\r\n+        },\r\n+      });\r\n+\r\n+      console.log('Invoice created successfully:', invoice);\r\n+      \r\n+      res.status(201).json({\r\n+        membership,\r\n+        invoice,\r\n+        message: 'Membership and invoice created successfully'\r\n+      });\r\n+      \r\n+    } catch (invoiceError) {\r\n+      console.error('Invoice creation error:', invoiceError);\r\n+      \r\n+      // If invoice creation fails, we might want to rollback the membership\r\n+      await prisma.membership.delete({\r\n+        where: { id: membership.id }\r\n+      });\r\n+      \r\n+      return res.status(500).json({ \r\n+        error: 'Failed to create invoice', \r\n+        details: invoiceError.message \r\n+      });\r\n+    }\r\n+\r\n+  } catch (err) {\r\n+    console.error('Add Membership Error:', err);\r\n+    res.status(500).json({ \r\n+      error: 'Failed to create membership',\r\n+      details: err.message \r\n+    });\r\n+  }\r\n+});\r\n+\r\n+\r\n+router.get('/', async (req, res) => {\r\n+  try {\r\n+    const { tab = 'all', search = '', page = 1, limit = 10, clubId, trainerId } = req.query;\r\n+    const skip = (Number(page) - 1) * Number(limit);\r\n+\r\n+    let whereClause: any = {\r\n+      clubId: String(clubId),\r\n+    };\r\n+\r\n+    if (trainerId) {\r\n+    whereClause.trainerId = trainerId; // âœ… FILTER BY TRAINER\r\n+  }\r\n+\r\n+    if (search) {\r\n+      whereClause.OR = [\r\n+        { firstName: { contains: search, mode: 'insensitive' } },\r\n+        { lastName: { contains: search, mode: 'insensitive' } },\r\n+        { email: { contains: search, mode: 'insensitive' } },\r\n+      ];\r\n+    }\r\n+\r\n+    switch (tab) {\r\n+      case 'active':\r\n+        whereClause.memberType = 'member';\r\n+        break;\r\n+      case 'expired':\r\n+        whereClause.memberType = 'member';\r\n+        whereClause.keyFob = null;\r\n+        break;\r\n+      case 'prospect':\r\n+        whereClause.memberType = 'prospect';\r\n+        break;\r\n+      case 'recent':\r\n+        const thirtyDaysAgo = new Date();\r\n+        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);\r\n+        whereClause.createdAt = { gte: thirtyDaysAgo };\r\n+        break;\r\n+      default:\r\n+        break;\r\n+    }\r\n+\r\n+    const [members, total] = await Promise.all([\r\n+      prisma.member.findMany({\r\n+        where: whereClause,\r\n+        orderBy: { createdAt: 'desc' },\r\n+        skip,\r\n+        take: Number(limit),\r\n+      }),\r\n+      prisma.member.count({ where: whereClause }),\r\n+    ]);\r\n+\r\n+    res.json({\r\n+      data: members,\r\n+      meta: {\r\n+        total,\r\n+        page: Number(page),\r\n+        pageSize: Number(limit),\r\n+      },\r\n+    });\r\n+  } catch (err) {\r\n+    console.error(err);\r\n+    res.status(500).json({ error: 'Failed to fetch members' });\r\n+  }\r\n+});\r\n+\r\n+router.get('/upcoming-renewals', async (req, res) => {\r\n+  const { clubId, days = 7 } = req.query;\r\n+\r\n+  if (!clubId) return res.status(400).json({ error: 'Missing clubId' });\r\n+\r\n+  const upcomingDate = new Date();\r\n+  upcomingDate.setDate(upcomingDate.getDate() + Number(days));\r\n+\r\n+  try {\r\n+    const count = await prisma.membership.count({\r\n+      where: {\r\n+        member: { clubId: String(clubId) },\r\n+        endDate: {\r\n+          gte: new Date(),\r\n+          lte: upcomingDate,\r\n+        },\r\n+        status: 'active',\r\n+      },\r\n+    });\r\n+\r\n+    res.json({ count });\r\n+  } catch (error) {\r\n+    console.error('Error fetching upcoming renewals:', error);\r\n+    res.status(500).json({ error: 'Failed to fetch upcoming renewals' });\r\n+  }\r\n+});\r\n+\r\n+\r\n+// GET /api/members/:id\r\n+router.get('/:id', async (req, res) => {\r\n+  const { id } = req.params;\r\n+\r\n+  try {\r\n+    const member = await prisma.member.findUnique({\r\n+      where: { id },\r\n+      include: {\r\n+        trainer: true,\r\n+        club: true,\r\n+        membership: {\r\n+      orderBy: { startDate: 'desc' }, // Get most recent first\r\n+      take: 1,                        // Optional: only return one latest\r\n+    },\r\n+      },\r\n+    });\r\n+\r\n+      console.log('ðŸ‘¨â€âš•ï¸ Full member details:', member); // âœ… ADD THIS\r\n+\r\n+    if (!member) return res.status(404).json({ error: 'Member not found' });\r\n+\r\n+    res.json(member);\r\n+  } catch (err) {\r\n+    console.error('Fetch member detail error:', err);\r\n+    res.status(500).json({ error: 'Failed to fetch member details' });\r\n+  }\r\n+});\r\n+\r\n+//update member\r\n+\r\n+// PUT /api/members/:id\r\n+router.put('/:id', async (req: Request, res: Response) => {\r\n+  try {\r\n+    const { id } = req.params;\r\n+    const updatedData = req.body;\r\n+\r\n+    const updated = await prisma.member.update({\r\n+      where: { id },\r\n+      data: {\r\n+        firstName: updatedData.firstName,\r\n+        lastName: updatedData.lastName,\r\n+        email: updatedData.email,\r\n+        phone: updatedData.phone,\r\n+        work: updatedData.work,\r\n+        dateOfBirth: updatedData.dateOfBirth ? new Date(updatedData.dateOfBirth) : null,\r\n+        gender: updatedData.gender,\r\n+        avatarUrl: updatedData.avatar || null,\r\n+        keyFob: updatedData.keyFob,\r\n+        tags: updatedData.tags,\r\n+        note: updatedData.note,\r\n+        memberType: updatedData.memberType,\r\n+\r\n+        // Address\r\n+        street: updatedData.address?.street || null,\r\n+        city: updatedData.address?.city || null,\r\n+        state: updatedData.address?.state || null,\r\n+        zip: updatedData.address?.zip || null,\r\n+        addressSearch: updatedData.address?.search || null,\r\n+\r\n+        // Marketing\r\n+        salesRep: updatedData.marketing?.salesRep || null,\r\n+        sourcePromotion: updatedData.marketing?.sourcePromotion || null,\r\n+        referredBy: updatedData.marketing?.referredBy || null,\r\n+\r\n+        // Additional\r\n+        trainerId: updatedData.additional?.trainerId || null,\r\n+        joiningDate: updatedData.additional?.joiningDate ? new Date(updatedData.additional.joiningDate) : null,\r\n+        occupation: updatedData.additional?.occupation || null,\r\n+        organization: updatedData.additional?.organization || null,\r\n+        involvementType: updatedData.additional?.involvementType || null,\r\n+\r\n+        // Emergency\r\n+        emergency: updatedData.emergency || [],\r\n+//medical information\r\n+        medicalInfo: updatedData.medicalInfo || '',\r\n+allergies: updatedData.allergies || '',\r\n+medications: updatedData.medications || '',\r\n+chronicConditions: updatedData.chronicConditions || '',\r\n+injuries: updatedData.injuries || '',\r\n+doctorContact: updatedData.doctorContact || '',\r\n+lastExamDate: updatedData.lastExamDate ? new Date(updatedData.lastExamDate) : null,\r\n+        clubId: updatedData.club,\r\n+      },\r\n+    });\r\n+\r\n+    return res.status(200).json(updated);\r\n+  } catch (err) {\r\n+    console.error('Error updating member:', err);\r\n+    return res.status(500).json({ error: 'Failed to update member' });\r\n+  }\r\n+});\r\n+\r\n+// GET /api/members/:id/sessions - All attendance sessions for a member\r\n+router.get('/:id/sessions', async (req, res) => {\r\n+  const { id } = req.params;\r\n+\r\n+  try {\r\n+    const attendanceRecords = await prisma.attendance.findMany({\r\n+      where: { memberId: id },\r\n+      orderBy: { markedAt: 'desc' },\r\n+      include: {\r\n+        schedule: {\r\n+          include: {\r\n+            trainer: { select: { name: true } },\r\n+            location: { select: { name: true } }\r\n+          }\r\n+        }\r\n+      }\r\n+    });\r\n+\r\n+    res.json(attendanceRecords);\r\n+  } catch (err) {\r\n+    console.error('Error fetching session history:', err);\r\n+    res.status(500).json({ error: 'Failed to fetch session history' });\r\n+  }\r\n+});\r\n+\r\n+// GET /api/members/join-trend\r\n+router.get('/join-trend', async (req, res) => {\r\n+  const { clubId } = req.query;\r\n+\r\n+  if (!clubId) return res.status(400).json({ error: 'Missing clubId' });\r\n+\r\n+  try {\r\n+    const result = await prisma.member.groupBy({\r\n+      by: ['joiningDate'],\r\n+      where: {\r\n+        clubId: String(clubId),\r\n+        memberType: 'member',\r\n+        joiningDate: {\r\n+          not: null,\r\n+        },\r\n+      },\r\n+      _count: {\r\n+        _all: true,\r\n+      },\r\n+      orderBy: {\r\n+        joiningDate: 'asc',\r\n+      },\r\n+    });\r\n+\r\n+    const trend = result.map((r) => ({\r\n+      date: r.joiningDate.toISOString().split('T')[0],\r\n+      count: r._count._all,\r\n+    }));\r\n+\r\n+    res.json(trend);\r\n+  } catch (err) {\r\n+    console.error('Join trend error:', err);\r\n+    res.status(500).json({ error: 'Failed to fetch join trend' });\r\n+  }\r\n+});\r\n+\r\n+\r\n+// GET /api/billing/revenue-trend\r\n+router.get('/revenue-trend', async (req, res) => {\r\n+  const { clubId } = req.query;\r\n+\r\n+  if (!clubId) return res.status(400).json({ error: 'Missing clubId' });\r\n+\r\n+  try {\r\n+    const results = await prisma.invoice.groupBy({\r\n+      by: ['issuedAt'],\r\n+      where: {\r\n+        clubId: String(clubId),\r\n+        status: 'paid',\r\n+      },\r\n+      _sum: {\r\n+        amount: true,\r\n+      },\r\n+      orderBy: {\r\n+        issuedAt: 'asc',\r\n+      },\r\n+    });\r\n+\r\n+    const trend = results.map((r) => ({\r\n+      date: r.issuedAt.toISOString().split('T')[0],\r\n+      revenue: r._sum.amount ?? 0,\r\n+    }));\r\n+\r\n+    res.json(trend);\r\n+  } catch (err) {\r\n+    console.error('Revenue trend error:', err);\r\n+    res.status(500).json({ error: 'Failed to fetch revenue trend' });\r\n+  }\r\n+});\r\n+\r\n+\r\n+\r\n+\r\n+\r\n+\r\n+\r\n+\r\n+\r\n+\r\n+\r\n+\r\n+export default router;\r\n"
                },
                {
                    "date": 1753045394971,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -598,5 +598,20 @@\n \r\n     res.json(trend);\r\n   } catch (err) {\r\n     console.error('Revenue trend error:', err);\r\n-    r\n\\ No newline at end of file\n+    res.status(500).json({ error: 'Failed to fetch revenue trend' });\r\n+  }\r\n+});\r\n+\r\n+\r\n+\r\n+\r\n+\r\n+\r\n+\r\n+\r\n+\r\n+\r\n+\r\n+\r\n+export default router;\r\n"
                },
                {
                    "date": 1753126183141,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -3,9 +3,11 @@\n import { PrismaClient } from '@prisma/client';\r\n import { Request, Response } from 'express';\r\n import { getMembersByTrainer } from '../controllers/member.controller';\r\n import { getMemberJoinTrend } from '../controllers/member.controller';\r\n+import { upload } from '../middlewares/upload';\r\n \r\n+\r\n const router = express.Router();\r\n const prisma = new PrismaClient();\r\n \r\n \r\n@@ -570,48 +572,17 @@\n });\r\n \r\n \r\n // GET /api/billing/revenue-trend\r\n-router.get('/revenue-trend', async (req, res) => {\r\n-  const { clubId } = req.query;\r\n \r\n-  if (!clubId) return res.status(400).json({ error: 'Missing clubId' });\r\n \r\n-  try {\r\n-    const results = await prisma.invoice.groupBy({\r\n-      by: ['issuedAt'],\r\n-      where: {\r\n-        clubId: String(clubId),\r\n-        status: 'paid',\r\n-      },\r\n-      _sum: {\r\n-        amount: true,\r\n-      },\r\n-      orderBy: {\r\n-        issuedAt: 'asc',\r\n-      },\r\n-    });\r\n \r\n-    const trend = results.map((r) => ({\r\n-      date: r.issuedAt.toISOString().split('T')[0],\r\n-      revenue: r._sum.amount ?? 0,\r\n-    }));\r\n \r\n-    res.json(trend);\r\n-  } catch (err) {\r\n-    console.error('Revenue trend error:', err);\r\n-    res.status(500).json({ error: 'Failed to fetch revenue trend' });\r\n-  }\r\n-});\r\n \r\n \r\n \r\n \r\n \r\n \r\n \r\n \r\n-\r\n-\r\n-\r\n-\r\n export default router;\r\n"
                }
            ],
            "date": 1752209752670,
            "name": "Commit-0",
            "content": "import express from 'express';\r\nimport { createMember } from '../controllers/member.controller';\r\nimport { validateMember } from '../middlewares/validateMember';\r\n\r\nconst router = express.Router();\r\n\r\nrouter.post('/members', validateMember, createMember);\r\n\r\nexport default router;\r\n"
        }
    ]
}